<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Adventure English - Jogo de Conversa√ß√£o</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --bg1:#a5b4fc; --bg2:#fbcfe8; --bg3:#fef3c7;
    }
    html,body{ height:100%; }
    body{ font-family:'Nunito',system-ui, -apple-system; background: linear-gradient(180deg,#f0f9ff 0%, #fff 100%); color:#0f172a; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    #startScreen{ position:fixed; inset:0; background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3)); display:flex; align-items:center; justify-content:center; z-index:60; flex-direction:column; overflow:hidden; }
    .balloon{ position:absolute; bottom:-140px; width:64px; height:86px; border-radius:50% 50% 45% 55%; box-shadow:0 6px 18px rgba(0,0,0,0.08); transform-origin:center bottom; animation:float 10s linear infinite; opacity:.95; }
    @keyframes float{ 0%{ transform:translateY(0) rotate(0deg); } 100%{ transform:translateY(-130vh) rotate(16deg); opacity:0; } }
    .card{ background: rgba(255,255,255,0.92); backdrop-filter: blur(6px); }
    .bubble-ai::after, .bubble-kid::after{ content:""; position:absolute; bottom:-6px; width:0; height:0; border:8px solid transparent; }
    .bubble-ai::after{ left:16px; border-top-color: rgba(255,255,255,.95); }
    .bubble-kid::after{ right:16px; border-top-color: rgba(255,255,255,.95); }
    .nice-scroll::-webkit-scrollbar{ width:10px; } .nice-scroll::-webkit-scrollbar-thumb{ background:linear-gradient(180deg,#60a5fa,#a78bfa); border-radius:8px; }
    .nice-scroll{ scrollbar-width: thin; scrollbar-color:#a78bfa transparent; }
    .vocab-card { transform-style: preserve-3d; transition: transform 0.6s; }
    .vocab-card.flipped { transform: rotateY(180deg); }
    .card-front, .card-back {
        backface-visibility: hidden; position: absolute; top: 0; left: 0;
        width: 100%; height: 100%; display: flex; align-items: center;
        justify-content: center; padding: 1rem; border-radius: 0.75rem;
    }
    .card-back { transform: rotateY(180deg); background: rgba(255,255,255,0.92); color: #0f172a; font-weight: bold; }

    /* Anima√ß√£o da Medalha */
    @keyframes medal-in {
      0% { transform: scale(0.8) translateY(20px); opacity: 0; }
      100% { transform: scale(1) translateY(0); opacity: 1; }
    }
    #medalModal.visible { opacity: 1; }
    #medalModal.visible #medalCard { animation: medal-in 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }

    /* Estilos dos Jogos */
    .game-option.selected {
        transform: scale(1.08);
        box-shadow: 0 0 0 3px #6d28d9;
        background-color: #f5d0fe;
    }
    .game-option.correct {
        box-shadow: 0 0 0 3px #16a34a;
        background-color: #dcfce7;
    }
    .game-option.incorrect {
        box-shadow: 0 0 0 3px #dc2626;
        background-color: #fee2e2;
        animation: shake 0.5s;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
  </style>
</head>
<body>

  <!-- START / ONBOARD -->
  <div id="startScreen">
    <div class="z-10 text-center px-6">
      <h1 class="text-4xl md:text-5xl font-extrabold text-white drop-shadow-lg mb-2">Adventure English üéà</h1>
      <p class="text-white/90 mb-6">Diga-nos seu nome e idade para come√ßar a aventura!</p>
      <div class="space-y-3">
        <input id="startName" type="text" placeholder="Seu nome (ex: Ana)" class="w-72 md:w-96 px-4 py-3 rounded-2xl text-center outline-none" />
        <input id="startAge" type="number" placeholder="Sua idade" min="5" max="12" class="w-72 md:w-96 px-4 py-3 rounded-2xl text-center outline-none" />
        <div class="flex gap-3 justify-center mt-3">
          <button id="btnStart" class="px-6 py-3 rounded-2xl bg-violet-600 text-white font-bold hover:bg-violet-700">Come√ßar üöÄ</button>
        </div>
      </div>
    </div>
    <div class="balloon" style="left:8%; background:linear-gradient(180deg,#fff,#f472b6); animation-delay:0s; transform:scale(0.9);"></div>
    <div class="balloon" style="left:28%; background:linear-gradient(180deg,#fff,#60a5fa); animation-delay:1.5s; transform:scale(1.1);"></div>
  </div>

  <!-- APP (hidden until onboarding) -->
  <div id="app" class="hidden max-w-7xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="h-12 w-12 rounded-2xl flex items-center justify-center text-2xl shadow-lg bg-gradient-to-br from-sky-400 to-violet-400 text-white">üá¨üáßüéà</div>
        <div>
          <h1 class="text-2xl md:text-3xl font-extrabold">Adventure English</h1>
          <p class="text-sm md:text-base text-slate-600">Jogo de conversa√ß√£o com IA (crian√ßas 5‚Äì12)</p>
        </div>
      </div>
      <div class="flex items-center gap-6">
        <!-- Navega√ß√£o de Views -->
        <div class="flex items-center gap-2 p-1 bg-slate-200 rounded-xl">
            <button id="viewToggleConversation" class="px-4 py-1.5 text-sm font-bold bg-white text-violet-600 rounded-lg shadow">üí¨ Conversa√ß√£o</button>
            <button id="viewToggleGames" class="px-4 py-1.5 text-sm font-bold text-slate-600 rounded-lg">üéÆ Jogos</button>
        </div>
        <div class="flex items-center gap-3">
            <label class="flex items-center gap-2 text-xs">
              <input id="translateToggle" type="checkbox" class="accent-fuchsia-500">
              Mostrar ajuda
            </label>
            <button id="testVoiceBtn" class="px-3 py-2 rounded-xl bg-sky-200 text-sky-900 text-sm">üîä Ouvir voz</button>
        </div>
      </div>
    </header>

    <!-- VIEW DE CONVERSA√á√ÉO -->
    <div id="conversationView">
        <section class="grid lg:grid-cols-3 gap-6 mt-6">
          <div class="card rounded-2xl p-4 shadow-lg">
            <h3 class="font-extrabold mb-3">Cenas de Roleplay</h3>
            <div id="sceneList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5"></div>
          </div>
          <div class="card rounded-2xl p-4 shadow-lg lg:col-span-2">
            <div class="flex items-center justify-between mb-3"><h3 class="font-extrabold">Categorias essenciais</h3><div class="text-xs text-slate-600">Selecione uma para ver vocabul√°rio</div></div>
            <div id="catList" class="flex flex-wrap gap-2 mb-4"></div>
            <div class="grid md:grid-cols-2 gap-6">
              <div><h4 class="font-bold mb-2">Vocabul√°rio</h4><div id="vocab" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div></div>
              <div><h4 class="font-bold mb-2">Miss√µes üéØ</h4><ul id="missions" class="list-disc pl-5 space-y-1 text-sm"></ul></div>
            </div>
          </div>
        </section>

        <main class="grid lg:grid-cols-3 gap-6 mt-6">
          <section class="lg:col-span-2 card rounded-2xl p-0 shadow-lg flex flex-col">
            <div class="flex items-center justify-between px-4 pt-4">
              <div><p id="activeSceneName" class="font-bold">Escolha uma cena</p><p class="text-xs text-slate-600">Dica: use frases curtas e emojis!</p></div>
              <div class="flex items-center gap-3">
                <button id="btnClear" class="text-xs px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200">Limpar chat</button>
                <button id="btnReset" class="text-xs px-3 py-2 rounded-lg bg-red-100 text-red-700 hover:bg-red-200">Reiniciar</button>
              </div>
            </div>
            <div id="chat" class="flex-1 px-4 pb-4 overflow-y-auto nice-scroll space-y-3 min-h-[320px]"></div>
            <form id="chatForm" class="border-t border-slate-100 p-3 flex items-end gap-2">
              <button type="button" id="btnHint" class="px-3 py-2 rounded-xl bg-amber-200 text-amber-900 font-bold hover:bg-amber-300">Dica üí°</button>
              <div class="flex-1">
                <textarea id="msgInput" rows="1" placeholder="Fale ou escreva em ingl√™s..." class="w-full resize-none rounded-xl border border-slate-200 px-3 py-2 outline-none focus:ring-2 focus:ring-violet-300"></textarea>
                <div class="flex items-center gap-2 mt-2">
                  <button type="button" id="btnMic" class="px-3 py-2 rounded-xl bg-emerald-500 text-white font-bold hover:bg-emerald-600">üé§ Falar</button>
                  <span id="micStatus" class="text-xs text-slate-600">Microfone pronto</span>
                </div>
              </div>
              <button id="btnSend" class="px-4 py-2 rounded-xl bg-violet-500 text-white font-extrabold hover:bg-violet-600">Enviar ‚ñ∂</button>
            </form>
          </section>
          <aside class="space-y-6">
             <section id="profile-card" class="card rounded-2xl p-4 shadow-lg">
              <h2 class="font-extrabold mb-3">Seu Perfil</h2>
              <div class="flex flex-wrap items-center gap-4">
                <div><label class="text-xs font-semibold">Nome</label><div id="profileName" class="text-lg font-bold">‚Äî</div></div>
                <div><label class="text-xs font-semibold">Idade</label><div id="profileAge" class="text-lg font-bold">‚Äî</div></div>
                <div class="ml-auto"><button id="editProfile" class="px-3 py-2 rounded-xl bg-amber-200 text-amber-900 text-sm">Editar</button></div>
              </div>
            </section>
            <section class="card rounded-2xl p-4 shadow-lg">
              <div class="flex items-center justify-between mb-3"><h3 class="font-extrabold">Progresso ‚≠ê</h3><div id="levelBadge" class="text-xs font-extrabold text-slate-900 px-2 py-1 rounded-lg">N√≠vel 1</div></div>
              <div class="flex items-center gap-2"><div id="stars" class="flex text-2xl">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</div><span id="xpText" class="text-xs text-slate-600">0/5</span></div>
              <p class="text-xs text-slate-600 mt-2">Ganhe estrelas usando palavras do tema!</p>
            </section>
            <section class="card rounded-2xl p-4 shadow-lg">
              <h3 class="font-extrabold mb-2">Voz atual üé§</h3><p id="currentVoice" class="text-sm text-slate-700">Nenhuma</p>
              <div class="mt-3"><label class="text-xs text-slate-600">Escolher voz</label><select id="voiceSelect" class="w-full mt-1 rounded-xl border border-slate-200 px-3 py-2"><option value="">(usar voz da cena)</option><option value="nova">Nova</option><option value="alloy">Alloy</option><option value="shimmer">Shimmer</option><option value="onyx">Onyx</option><option value="fable">Fable</option><option value="echo">Echo</option></select></div>
            </section>
            <section class="card rounded-2xl p-4 shadow-lg"><h3 class="font-extrabold mb-2">Medalhas üèÖ</h3><div id="badges" class="flex flex-wrap gap-2"></div></section>
          </aside>
        </main>
    </div>

    <!-- VIEW DE JOGOS -->
    <div id="gamesView" class="hidden">
        <div class="card rounded-2xl p-6 shadow-lg mt-6">
            <h2 class="text-2xl font-extrabold mb-4">Central de Jogos üéÆ</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <button class="bg-violet-500 text-white font-bold py-3 rounded-xl">Ligar Palavra-Emoji</button>
                <button class="bg-slate-200 text-slate-600 font-bold py-3 rounded-xl cursor-not-allowed">Jogo da Mem√≥ria (em breve)</button>
                <button class="bg-slate-200 text-slate-600 font-bold py-3 rounded-xl cursor-not-allowed">Ca√ßa-Palavras (em breve)</button>
                <button class="bg-slate-200 text-slate-600 font-bold py-3 rounded-xl cursor-not-allowed">O que Falta? (em breve)</button>
            </div>
            
            <!-- Jogo: Ligar Palavra-Emoji -->
            <div id="wordEmojiGame">
                <div class="text-center mb-4">
                    <p id="gameInstruction" class="font-bold">Ligue a palavra em ingl√™s com o emoji correto!</p>
                    <p id="gameFeedback" class="text-sm h-5"></p>
                </div>
                <div class="grid grid-cols-2 gap-6 max-w-2xl mx-auto">
                    <div id="gameWordsContainer" class="grid grid-cols-1 gap-3"></div>
                    <div id="gameEmojisContainer" class="grid grid-cols-3 gap-3"></div>
                </div>
                <div id="gameWinMessage" class="hidden text-center mt-6">
                    <p class="text-2xl font-bold text-emerald-600">üéâ Voc√™ conseguiu! üéâ</p>
                    <button id="playAgainBtn" class="mt-4 px-6 py-2 bg-emerald-500 text-white font-bold rounded-xl">Jogar Novamente</button>
                </div>
            </div>
        </div>
    </div>
  </div>

  <div id="confirmModal" class="fixed inset-0 bg-slate-900 bg-opacity-60 hidden items-center justify-center p-4 z-70">
    <div class="bg-white rounded-2xl p-6 shadow-xl max-w-sm w-full">
      <h3 class="font-extrabold text-xl mb-2">Reiniciar Progresso?</h3><p class="text-slate-600 text-sm mb-4">Esta a√ß√£o apagar√° todo o seu progresso.</p>
      <div class="flex justify-end gap-3"><button id="cancelReset" class="px-4 py-2 rounded-xl bg-slate-200 font-bold hover:bg-slate-300">Cancelar</button><button id="confirmReset" class="px-4 py-2 rounded-xl bg-red-500 text-white font-bold hover:bg-red-600">Confirmar</button></div>
    </div>
  </div>

  <!-- Medal Unlocked Animation -->
  <div id="medalModal" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center p-4 z-[80] transition-opacity duration-300 opacity-0">
    <div id="medalCard" class="bg-white rounded-3xl p-6 shadow-xl max-w-sm w-full text-center transform scale-90 opacity-0 transition-all duration-300">
      <div id="medalEmoji" class="text-7xl mb-4 animate-bounce"></div>
      <h2 class="text-2xl font-extrabold text-amber-500 mb-2">Parab√©ns!</h2>
      <p class="text-slate-700 font-bold text-lg mb-1">Voc√™ ganhou a medalha:</p>
      <p id="medalName" class="font-bold text-xl text-violet-600"></p>
      <p id="medalDesc" class="text-sm text-slate-500 mt-2"></p>
      <button id="closeMedalModal" class="mt-6 px-5 py-2 bg-slate-200 text-slate-800 font-bold rounded-xl hover:bg-slate-300">Fechar</button>
    </div>
  </div>

<script>
/* =========================
   CONFIGURA√á√ÉO
   ========================= */
const BACKEND_URL = ''; 

const state = {
  sceneId: null, categoryId: null, stars: 0, level: 1, showTranslation: false, history: [],
  achievements: {}, userName: null, age: null, voice: null, currentAudio: null, vocabExpanded: {},
  currentGame: { selectedWord: null, selectedEmoji: null, pairsLeft: 0 }
};

/* ---------- DADOS (CENAS, CATEGORIAS, VOCABUL√ÅRIO) ---------- */
const scenes = [
  { id:'teacher', name:'Professora Daisy', nameEn:'Teacher Daisy', icon:'üßë‚Äçüè´', style:'calma, encorajadora', persona: 'Your name is Mrs. Daisy. You are a kind and patient teacher. Ask the child about their day at school, their favorite subject, and what they like to read.'},
  { id:'zoo', name:'Guia do Zoo Leo', nameEn:'Zoo Guide Leo', icon:'ü¶Å', style:'curioso, divertido', persona: 'Your name is Leo, a 25-year-old zoo guide who loves animals. Share fun facts about animals and ask the child about their favorites. Make animal sounds.'},
  { id:'restaurant', name:'Gar√ßom Sam', nameEn:'Waiter Sam', icon:'üçΩÔ∏è', style:'educado, paciente', persona: 'Your name is Sam, a friendly waiter. Welcome the child to your restaurant, ask for their order, and suggest delicious food from the menu.'},
  { id:'doctor', name:'M√©dica Isabella', nameEn:'Doctor Isabella', icon:'ü©∫', style:'gentil, cuidadosa', persona: 'You are Dr. Isabella, a caring doctor. Ask the child how they are feeling. If they mention pain, offer simple, comforting advice like resting or drinking water. Never give real medical advice.' },
  { id:'shop', name:'Vendedora Chloe', nameEn:'Seller Chloe', icon:'üõçÔ∏è', style:'prestativa, alegre', persona: 'Your name is Chloe, a cheerful teenager working at a clothing store. Help the child pick out clothes, compliment their choices, and ask about their favorite colors.'},
  { id:'playground', name:'Amiga Lily', nameEn:'Playground Friend Lily', icon:'üõù', style:'brincalhona, animada', persona: 'Your name is Lily. You are the same age as the child you are talking to. Be very playful and energetic. Invite them to play on the swings, slides, and talk about your favorite games.'},
];
const sceneVoices = { teacher: "nova", zoo: "alloy", restaurant: "shimmer", doctor: "nova", shop: "shimmer", playground: "shimmer" };
const categories = [
    { id:'greetings', icon:'üëã', name:'Sauda√ß√µes', englishName: 'Greetings', missions:['Apresente-se: ‚ÄúHello! My name is __.‚Äù','Pergunte o nome: ‚ÄúWhat is your name?‚Äù','Despe√ßa-se: ‚ÄúGoodbye! See you!‚Äù'], vocab:[['hello', 'ol√°'], ['goodbye', 'tchau'], ['please', 'por favor'], ['thank you', 'obrigado(a)'], ['sorry', 'desculpa'], ['name', 'nome']]},
    { id:'numbers', icon:'üî¢', name:'N√∫meros', englishName: 'Numbers', missions:['Conte at√© cinco: ‚ÄúOne, two, three, four, five!‚Äù','Diga sua idade: ‚ÄúI am __ years old.‚Äù','Pergunte a idade: ‚ÄúHow old are you?‚Äù'], vocab:[['one', 'um'], ['two', 'dois'], ['three', 'tr√™s'], ['four', 'quatro'], ['five', 'cinco'], ['six', 'seis']]},
    { id:'colors', icon:'üé®', name:'Cores', englishName: 'Colors', missions:['Descreva: ‚ÄúMy ball is red.‚Äù','Pergunte: ‚ÄúWhat color is it?‚Äù'], vocab:[['red', 'vermelho'], ['blue', 'azul'], ['green', 'verde'], ['yellow', 'amarelo'], ['pink', 'rosa'], ['orange', 'laranja']]},
    { id:'animals', icon:'üêæ', name:'Animais', englishName: 'Animals', missions:['Diga o que v√™: ‚ÄúI see a __.‚Äù','Qual seu animal favorito?'], vocab:[['cat', 'gato'], ['dog', 'cachorro'], ['bird', 'p√°ssaro'], ['fish', 'peixe'], ['lion', 'le√£o'], ['monkey', 'macaco']]},
    { id:'food', icon:'üçé', name:'Comida', englishName: 'Food', missions:['Fa√ßa um pedido: ‚ÄúI would like __, please.‚Äù','Diga o que gosta: ‚ÄúI like __.‚Äù'], vocab:[['apple', 'ma√ß√£'], ['banana', 'banana'], ['milk', 'leite'], ['water', '√°gua'], ['bread', 'p√£o'], ['pizza', 'pizza']]},
    { id:'family', icon:'üë®‚Äçüë©‚Äçüëß', name:'Fam√≠lia', englishName: 'Family', missions:['Apresente algu√©m: ‚ÄúThis is my __.‚Äù','Pergunte: ‚ÄúWho is he/she?‚Äù'], vocab:[['mother', 'm√£e'], ['father', 'pai'], ['brother', 'irm√£o'], ['sister', 'irm√£'], ['baby', 'beb√™'], ['friend', 'amigo(a)']]},
];
const gameVocab = {
    'animals': [['cat','üê±'], ['dog','üê∂'], ['bird','üê¶'], ['fish','üê†'], ['lion','ü¶Å'], ['monkey','üêµ']],
    'food': [['apple','üçé'], ['banana','üçå'], ['pizza','üçï'], ['milk','ü•õ'], ['bread','üçû'], ['cake', 'üç∞']],
    'colors': [['red','üî¥'], ['blue','üîµ'], ['green','üü¢'], ['yellow','üü°'], ['orange','üü†'], ['purple','üü£']],
};

/* ---------- UTILIT√ÅRIOS ---------- */
const $ = sel => document.querySelector(sel);
const chatEl = $('#chat'); const msgInput = $('#msgInput');
function scrollBottom(){ chatEl.scrollTo({ top: chatEl.scrollHeight, behavior: 'smooth' }); }
function shuffle(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }


/* ---------- √ÅUDIO E SONS ---------- */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSynth({type='sine', freq=600, length=0.08, gain=0.08, glide=false}){ try{ const o=audioCtx.createOscillator(),g=audioCtx.createGain(),d=audioCtx.currentTime; o.type=type; o.frequency.setValueAtTime(freq,d); g.gain.setValueAtTime(gain,d); if(glide){o.frequency.exponentialRampToValueAtTime(freq*1.6,d+length)} o.connect(g);g.connect(audioCtx.destination);o.start(d);o.stop(d+length) }catch(e){} }
function playPop(){ playSynth({type:'triangle', freq:800, length:0.08, gain:0.06}); }
function playCorrect(){ playSynth({type:'sine', freq:800, length:0.1, gain:0.08, glide:true}); }
function playWrong(){ playSynth({type:'square', freq:200, length:0.15, gain:0.05}); }
function playAchievementSound(){ playSynth({type:'sine', freq:523.25, length:0.1, gain:0.08}); setTimeout(()=>playSynth({type:'sine', freq:659.25, length:0.1, gain:0.08}), 120); setTimeout(()=>playSynth({type:'sine', freq:783.99, length:0.1, gain:0.08}), 240); setTimeout(()=>playSynth({type:'sine', freq:1046.50, length:0.2, gain:0.1, glide:true}), 360); }
async function ttsSpeak(text, button = null) {
    if (state.currentAudio) { state.currentAudio.pause(); state.currentAudio.onended = null; state.currentAudio.src = ''; state.currentAudio = null; }
    if (audioCtx.state === 'suspended') { await audioCtx.resume().catch(()=>{}); }
    if (button) { button.disabled = true; button.textContent = 'üîÑ'; }
    const voiceToUse = $('#voiceSelect')?.value || state.voice || 'alloy';
    try {
        const res = await fetch(`${BACKEND_URL}/api/tts`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ input: text, voice: voiceToUse })
        });
        if (!res.ok) { throw new Error('TTS failed with status ' + res.status); }
        const blob = await res.blob();
        const newAudio = new Audio(URL.createObjectURL(blob));
        state.currentAudio = newAudio;
        await newAudio.play().catch(e => console.warn("Autoplay was blocked", e));
        newAudio.onended = () => {
            if (button && document.body.contains(button)) { button.disabled = false; button.textContent = 'üîä'; }
            if (state.currentAudio === newAudio) { state.currentAudio = null; }
        };
    } catch (err) {
        console.error("TTS Error:", err);
        addMsg({from:'ai', text:'Desculpe, tive um problema para gerar o √°udio. üîá', translate:false, speak:false});
        if (button) { button.disabled = false; button.textContent = 'üîä'; }
    }
}

/* ---------- UI: MENSAGENS, MEDALHAS, CENAS, ETC. ---------- */
function addMsg({from='ai', text, translate=true, speak=true}){
  const wrap=document.createElement('div');
  wrap.className=`relative flex ${from==='ai'?'justify-start':'justify-end'}`;

  const bubble=document.createElement('div');
  bubble.className=`relative max-w-[82%] px-4 py-3 rounded-2xl shadow card ${from==='ai'?'bubble-ai':'bubble-kid'}`;
  bubble.style.margin='6px 0';

  let englishText = text;
  let portugueseText = null;

  if (from === 'ai' && text.includes('[TRANSLATION]')) {
    const parts = text.split('[TRANSLATION]');
    englishText = parts[0].trim();
    portugueseText = parts[1].trim();
  }

  const contentDiv=document.createElement('div');
  contentDiv.className='text-[15px] leading-relaxed';
  contentDiv.textContent = englishText;
  bubble.appendChild(contentDiv);

  if (state.showTranslation && from === 'ai' && portugueseText) {
    const t=document.createElement('div');
    t.className='text-[12px] text-slate-600 mt-1';
    t.textContent = `PT: ${portugueseText}`;
    bubble.appendChild(t);
  }

  if (from==='ai'){
    const controls=document.createElement('div');
    controls.style.marginTop='8px';
    const listenBtn=document.createElement('button');
    listenBtn.className='px-3 py-1 rounded-full text-xs bg-sky-100 hover:bg-sky-200 text-sky-900 font-bold';
    listenBtn.textContent='üîä Ouvir';
    listenBtn.onclick=()=>ttsSpeak(englishText, listenBtn);
    controls.appendChild(listenBtn);
    bubble.appendChild(controls);
    if(speak) ttsSpeak(englishText);
  }

  wrap.appendChild(bubble);
  chatEl.appendChild(wrap);
  scrollBottom();
}
function setStars(n){
  state.stars=n; $('#stars').textContent='‚òÖ'.repeat(n)+'‚òÜ'.repeat(5-n); $('#xpText').textContent=`${n}/5`;
  if(n>=5){ state.level++; $('#levelBadge').textContent=`N√≠vel ${state.level}`; giveMedal('five-stars'); setTimeout(()=>setStars(0),400); }
}
const medalDefs = [
  {id:'first-talk', label:'1¬™ conversa', emoji:'ü•á', descEn: "You sent your first message!", descPt: "Voc√™ enviou sua primeira mensagem!"},
  {id:'vocab-star', label:'Palavra do Tema', emoji:'üåü', descEn: "You used a word from the category!", descPt: "Voc√™ usou uma palavra da categoria!"},
  {id:'five-stars', label:'5 Estrelas', emoji:'‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê', descEn: "You earned 5 stars in a category!", descPt: "Voc√™ ganhou 5 estrelas em uma categoria!"},
  {id:'animal-fan', label:'Amigo dos Animais', emoji:'üêæ', descEn: "You talked about animals!", descPt: "Voc√™ falou sobre animais!"},
  {id:'polite-kid', label:'Crian√ßa Educada', emoji:'üôè', descEn: "You were very polite!", descPt: "Voc√™ foi muito educado(a)!"},
  {id:'curious-mind', label:'Mente Curiosa', emoji:'‚ùì', descEn: "You asked a question!", descPt: "Voc√™ fez uma pergunta!"},
  {id:'feeling-fine', label:'Expressivo', emoji:'üòä', descEn: "You talked about your feelings!", descPt: "Voc√™ falou sobre seus sentimentos!"}
];

function showMedalAnimation(medal) {
  const modal = $('#medalModal'), card = $('#medalCard'), emoji = $('#medalEmoji'), name = $('#medalName'), desc = $('#medalDesc');
  emoji.textContent = medal.emoji; name.textContent = medal.label; desc.textContent = `${medal.descEn} / ${medal.descPt}`;
  modal.classList.remove('hidden'); modal.classList.add('flex');
  setTimeout(() => { modal.classList.add('visible'); playAchievementSound(); }, 10);
  const hide = () => { modal.classList.remove('visible'); setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('flex'); }, 300); };
  const hideTimeout = setTimeout(hide, 5000);
  $('#closeMedalModal').onclick = () => { clearTimeout(hideTimeout); hide(); };
}
function renderBadges(){
  const box=$('#badges'); box.innerHTML='';
  medalDefs.forEach(m=>{
    const got=!!state.achievements[m.id];
    const b=document.createElement('div'); b.className=`px-3 py-2 rounded-xl border ${got?'border-emerald-300 bg-emerald-50 text-emerald-800':'border-slate-200 bg-white/70 text-slate-500'}`;
    b.innerHTML=`<span class="mr-1">${m.emoji}</span> <span class="font-bold">${m.label}</span>`; box.appendChild(b);
  });
}
function giveMedal(id){
  if(state.achievements[id])return;
  state.achievements[id] = true;
  renderBadges();
  const medal = medalDefs.find(m => m.id === id);
  if (medal) { showMedalAnimation(medal); }
}
function renderScenes(){
  const box=$('#sceneList'); box.innerHTML='';
  scenes.forEach(s=>{
    const btn=document.createElement('button'); btn.className='pick w-full text-left px-4 py-3 rounded-xl border border-slate-200 hover:border-violet-300 hover:bg-violet-50 transition';
    btn.innerHTML=`<div class="flex items-center gap-3"><div class="h-10 w-10 rounded-xl flex items-center justify-center text-2xl" style="background:linear-gradient(135deg,#60a5fa,#a78bfa);color:white;">${s.icon}</div><div><div class="font-extrabold">${s.name}</div><div class="text-xs text-slate-600">${s.style}</div></div></div>`;
    btn.addEventListener('click',()=>{
      state.sceneId=s.id; state.voice=sceneVoices[s.id]||'alloy'; $('#activeSceneName').textContent=s.name;
      [...box.children].forEach(c=>c.classList.remove('ring-2','ring-violet-400','bg-violet-50'));
      btn.classList.add('ring-2','ring-violet-400','bg-violet-50'); $('#currentVoice').textContent=`Voz: ${state.voice}`;
      addMsg({from:'ai',text:`Hello! My name is ${s.nameEn.split(' ')[1]}! Let's talk! üòä [TRANSLATION] Ol√°! O meu nome √© ${s.name.split(' ')[1]}! Vamos conversar! üòä`,translate:true}); playPop();
    });
    box.appendChild(btn);
  });
}
function renderCategories(){
  const box=$('#catList'); box.innerHTML='';
  categories.forEach(c=>{
    const chip=document.createElement('button'); chip.className='pick px-3 py-2 rounded-full text-sm border border-slate-200 bg-white/70 hover:bg-white font-bold';
    chip.innerHTML=`${c.icon} ${c.name}`;
    chip.addEventListener('click',()=>{
      state.categoryId=c.id;
      [...box.children].forEach(ch=>ch.classList.remove('ring-2','ring-sky-400','bg-sky-50'));
      chip.classList.add('ring-2','ring-sky-400','bg-sky-50'); renderVocab(); renderMissions();
      addMsg({from:'ai',text:`Great choice: ${c.englishName}! Try to use one of these words. üåü [TRANSLATION] √ìtima escolha: ${c.name}! Tente usar uma dessas palavras. üåü`,translate:true}); playPop();
    });
    box.appendChild(chip);
  });
}
function renderVocab(){
  const c=categories.find(x=>x.id===state.categoryId),box=$('#vocab'); box.innerHTML='';
  if(!c){ box.innerHTML='<div class="text-sm text-slate-600 col-span-full">Escolha uma categoria.</div>'; return; }
  const isExpanded=!!state.vocabExpanded[state.categoryId],wordsToDisplay=isExpanded?c.vocab:c.vocab.slice(0,6);
  wordsToDisplay.forEach(([en,pt])=>{
    const card=document.createElement('div'); card.className='vocab-card w-full h-20 relative cursor-pointer'; card.style.perspective='1000px';
    const front=document.createElement('div'); front.className='card-front border border-slate-200 bg-white/80 hover:bg-white text-center'; front.innerHTML=`<div class="font-extrabold text-sm text-slate-800 capitalize">${en}</div>`;
    const back=document.createElement('div'); back.className='card-back border border-slate-200'; back.innerHTML=`<div class="font-bold text-sm text-slate-800 capitalize">${pt}</div>`;
    card.append(front,back); card.addEventListener('click',()=>{ card.classList.toggle('flipped'); ttsSpeak(en,null); if(card.classList.contains('flipped')){setTimeout(()=>card.classList.remove('flipped'),5000)} });
    box.appendChild(card);
  });
  const btnContainer=document.createElement('div'); btnContainer.className='sm:col-span-3 col-span-2 flex items-center justify-center';
  if(isExpanded){
    const lessBtn=document.createElement('button'); lessBtn.className='w-full px-4 py-2 rounded-xl bg-slate-100 text-slate-800 font-bold hover:bg-slate-200 transition';
    lessBtn.textContent='Mostrar menos...'; lessBtn.onclick=()=>{state.vocabExpanded[state.categoryId]=false;playPop();renderVocab();}; btnContainer.appendChild(lessBtn);
  }else if(c.vocab.length>6){
    const moreBtn=document.createElement('button'); moreBtn.className='w-full px-4 py-2 rounded-xl bg-sky-100 text-sky-800 font-bold hover:bg-sky-200 transition';
    moreBtn.textContent=`Mostrar mais (${c.vocab.length-6})...`; moreBtn.onclick=()=>{state.vocabExpanded[state.categoryId]=true;playPop();renderVocab();}; btnContainer.appendChild(moreBtn);
  }
  if(btnContainer.hasChildNodes()) box.appendChild(btnContainer);
}
function renderMissions(){
  const c=categories.find(x=>x.id===state.categoryId),ul=$('#missions'); ul.innerHTML='';
  if(!c){ ul.innerHTML='<li class="text-slate-600">Escolha uma categoria.</li>'; return; }
  c.missions.forEach(m=>{const li=document.createElement('li');li.className='text-slate-700';li.textContent=m.replace('__',state.userName||'...');ul.appendChild(li);});
}

/* ---------- L√ìGICA DO CHAT COM BACKEND ---------- */
function getAgeGuidance(age){
  if(!age||age>9)return'Use simple English (A2 level). You can introduce a new word occasionally.';
  if(age<=6)return'Use extremely simple English (A0 level), with 1-4 word sentences and lots of emojis.';
  return'Use simple English (A1 level). Use short, clear sentences. Ask simple questions.';
}
function buildSystemPrompt() {
  const scene = scenes.find(s => s.id === state.sceneId);
  
  // Special instruction for the playground friend to match the user's age.
  let persona_instruction = scene ? scene.persona : 'You are a friendly helper.';
  if (scene && scene.id === 'playground' && state.age) {
      persona_instruction = `Your name is Lily. You are ${state.age} years old, just like your new friend! Be very playful and energetic. Invite them to play on the swings, slides, and talk about your favorite games.`;
  }

  return `You are an AI acting as a character for a roleplay with a ${state.age || 'young'} year-old child named ${state.userName || 'friend'}.

**CHARACTER PERSONA: ${persona_instruction}**

**CORE INSTRUCTIONS:**
1.  **NEVER BREAK CHARACTER:** You are NOT an AI. You are the character described in your PERSONA. If the child asks your name, age, or personal questions, answer using your character's details. Fully embody the role.
2.  **GRAMMAR CORRECTION:** Your most important task is to help the child learn. If the child makes a CLEAR grammatical mistake (like "he go" instead of "he goes"), you MUST gently correct it. If the child's sentence is correct, DO NOT rephrase it. Just praise them and continue the conversation naturally.
3.  **ADAPT TO AGE:** Your language style MUST be adapted for a ${state.age || 'young'} year-old child. ${getAgeGuidance(state.age)}
4.  **STAY ON TOPIC:** Keep the conversation related to your character's context (e.g., the zoo, the playground).
5.  **KEEP IT SHORT:** Respond in 1-3 short sentences. NEVER switch to Portuguese.
6.  **TRANSLATION:** After your complete English response, ALWAYS add a separator on a new line: [TRANSLATION]. On the next line, provide a full, natural Portuguese translation of your English response.
End.`.trim();
}
async function handleSend(text){
  if(!text||!text.trim())return; addMsg({from:'kid',text:text,speak:false});
  const lower=text.toLowerCase(),cat=categories.find(c=>c.id===state.categoryId);
  if(cat&&cat.vocab.some(([en])=>lower.includes(en.toLowerCase()))){setStars(Math.min(5,state.stars+1));giveMedal('vocab-star');}
  if(/(please|thank you)/i.test(lower))giveMedal('polite-kid'); if(/\b(what|where|who|how|why|do you)\b/i.test(lower))giveMedal('curious-mind');
  if (/(happy|sad|love|like|fine|good|great)/i.test(lower)) giveMedal('feeling-fine');
  if(!state.achievements['first-talk'])giveMedal('first-talk');
  try{
    state.history.push({role:'user',content:text});
    const res=await fetch(`${BACKEND_URL}/api/chat`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:state.history.slice(-12),systemPrompt:buildSystemPrompt()})});
    if(!res.ok)throw new Error('Falha na comunica√ß√£o com o backend: '+res.status);
    const data=await res.json(),aiText=data.reply||'I am here to help! üòä';
    addMsg({from:'ai',text:aiText,translate:true}); state.history.push({role:'assistant',content:aiText});
  }catch(err){console.error(err);addMsg({from:'ai',text:'Tive um problema de comunica√ß√£o com o servidor. üõü',translate:false,speak:false});}
}

/* ---------- L√ìGICA DOS JOGOS ---------- */
function startWordEmojiGame() {
    const gameFeedback = $('#gameFeedback');
    const wordsContainer = $('#gameWordsContainer');
    const emojisContainer = $('#gameEmojisContainer');
    const winMessage = $('#gameWinMessage');

    gameFeedback.textContent = '';
    winMessage.classList.add('hidden');
    wordsContainer.innerHTML = '';
    emojisContainer.innerHTML = '';
    state.currentGame = { selectedWord: null, selectedEmoji: null, pairsLeft: 0 };

    const categoryKeys = Object.keys(gameVocab);
    const randomCategoryKey = categoryKeys[Math.floor(Math.random() * categoryKeys.length)];
    const gamePairs = [...gameVocab[randomCategoryKey]];
    state.currentGame.pairsLeft = gamePairs.length;

    const words = shuffle(gamePairs.map(p => p[0]));
    const emojis = shuffle(gamePairs.map(p => p[1]));

    words.forEach(word => {
        const btn = document.createElement('button');
        btn.className = 'game-option p-4 bg-white rounded-xl border-2 border-slate-200 font-bold capitalize transition-transform';
        btn.textContent = word;
        btn.dataset.word = word;
        btn.onclick = () => handleWordSelect(btn);
        wordsContainer.appendChild(btn);
    });

    emojis.forEach(emoji => {
        const btn = document.createElement('button');
        btn.className = 'game-option p-4 bg-white rounded-xl border-2 border-slate-200 text-3xl transition-transform';
        btn.textContent = emoji;
        btn.dataset.emoji = emoji;
        btn.onclick = () => handleEmojiSelect(btn);
        emojisContainer.appendChild(btn);
    });
}

function handleWordSelect(btn) {
    if (state.currentGame.selectedWord) {
        document.querySelectorAll('[data-word]').forEach(b => b.classList.remove('selected'));
    }
    state.currentGame.selectedWord = btn;
    btn.classList.add('selected');
    checkGameMatch();
}

function handleEmojiSelect(btn) {
    if (state.currentGame.selectedEmoji) {
        document.querySelectorAll('[data-emoji]').forEach(b => b.classList.remove('selected'));
    }
    state.currentGame.selectedEmoji = btn;
    btn.classList.add('selected');
    checkGameMatch();
}

function checkGameMatch() {
    const { selectedWord, selectedEmoji } = state.currentGame;
    if (!selectedWord || !selectedEmoji) return;

    const word = selectedWord.dataset.word;
    const emoji = selectedEmoji.dataset.emoji;
    
    const category = Object.values(gameVocab).flat();
    const correctPair = category.find(p => p[0] === word);

    const gameFeedback = $('#gameFeedback');

    if (correctPair && correctPair[1] === emoji) {
        gameFeedback.textContent = 'Correto! üéâ';
        gameFeedback.className = 'text-sm h-5 text-emerald-600 font-bold';
        selectedWord.classList.add('correct');
        selectedEmoji.classList.add('correct');
        selectedWord.disabled = true;
        selectedEmoji.disabled = true;
        playCorrect();
        state.currentGame.pairsLeft--;
        if (state.currentGame.pairsLeft === 0) {
            $('#gameWinMessage').classList.remove('hidden');
        }
    } else {
        gameFeedback.textContent = 'Tente novamente! üòü';
        gameFeedback.className = 'text-sm h-5 text-red-600 font-bold';
        selectedWord.classList.add('incorrect');
        selectedEmoji.classList.add('incorrect');
        playWrong();
        setTimeout(() => {
            selectedWord.classList.remove('incorrect', 'selected');
            selectedEmoji.classList.remove('incorrect', 'selected');
        }, 800);
    }
    
    // Reset selection
    state.currentGame.selectedWord = null;
    state.currentGame.selectedEmoji = null;
    if (! (correctPair && correctPair[1] === emoji)) {
       setTimeout(() => {
            document.querySelectorAll('.game-option').forEach(b => b.classList.remove('selected'));
            gameFeedback.textContent = '';
        }, 1000);
    }
}


/* ---------- EVENTOS E INICIALIZA√á√ÉO ---------- */
function setupEventListeners(){
  // Navega√ß√£o de Views
  const conversationView = $('#conversationView');
  const gamesView = $('#gamesView');
  const btnConversation = $('#viewToggleConversation');
  const btnGames = $('#viewToggleGames');

  btnConversation.addEventListener('click', () => {
      conversationView.style.display = 'block';
      gamesView.style.display = 'none';
      btnConversation.classList.add('bg-white', 'text-violet-600', 'shadow');
      btnGames.classList.remove('bg-white', 'text-violet-600', 'shadow');
  });
  btnGames.addEventListener('click', () => {
      conversationView.style.display = 'none';
      gamesView.style.display = 'block';
      btnGames.classList.add('bg-white', 'text-violet-600', 'shadow');
      btnConversation.classList.remove('bg-white', 'text-violet-600', 'shadow');
      startWordEmojiGame();
  });
  
  $('#playAgainBtn').addEventListener('click', startWordEmojiGame);


  $('#btnHint').addEventListener('click',()=>{const c=categories.find(x=>x.id===state.categoryId);let hint=c&&c.missions.length?c.missions[Math.floor(Math.random()*c.missions.length)]:'Try a short sentence in English. üòÄ';addMsg({from:'ai',text:hint.replace('__',state.userName||'...'),translate:true});});
  $('#btnClear').addEventListener('click',()=>{chatEl.innerHTML='';state.history=[];addMsg({from:'ai',text:'New beginning! Choose a scene to continue. ‚ú®',translate:true,speak:true});});
  $('#btnReset').addEventListener('click',()=>{ $('#confirmModal').classList.remove('hidden'); $('#confirmModal').classList.add('flex'); });
  $('#cancelReset').addEventListener('click',()=>{ $('#confirmModal').classList.add('hidden'); $('#confirmModal').classList.remove('flex'); });
  $('#confirmReset').addEventListener('click',()=>{localStorage.clear();window.location.reload();});
  $('#chatForm').addEventListener('submit',e=>{e.preventDefault();const text=msgInput.value.trim();if(text){msgInput.value='';msgInput.style.height='auto';handleSend(text);}});
  msgInput.addEventListener('input',()=>{msgInput.style.height='auto';msgInput.style.height=Math.min(120,msgInput.scrollHeight)+'px';});
  msgInput.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();$('#chatForm').dispatchEvent(new Event('submit'));}});
  $('#translateToggle').addEventListener('change',e=>{state.showTranslation=!!e.target.checked;});
  $('#voiceSelect').addEventListener('change',()=>{const v=$('#voiceSelect').value;$('#currentVoice').textContent=v?`Voz: ${v}`:`Voz: ${state.voice||'‚Äî'}`;});
  $('#testVoiceBtn').addEventListener('click',()=>{ttsSpeak(state.userName?`Hello ${state.userName}, nice to meet you!`:'Hello! Let us practice!',null);});
  $('#editProfile').addEventListener('click',()=>{ $('#startName').value=state.userName||''; $('#startAge').value=state.age||''; $('#startScreen').style.display='flex'; $('#app').classList.add('hidden');});
  $('#btnStart').addEventListener('click',()=>{
    const name=$('#startName').value.trim(),age=$('#startAge').value.trim();
    if(!name||!age){const msg=document.createElement('div');msg.textContent='Por favor, preencha nome e idade.';msg.className='text-red-600 font-bold mt-2 text-sm';const oldMsg=$('#startScreen').querySelector('.text-red-600');if(oldMsg)oldMsg.remove();$('#btnStart').parentElement.insertBefore(msg,$('#btnStart'));return;}
    state.userName=name;state.age=age;localStorage.setItem('ae_name',name);localStorage.setItem('ae_age',age);
    $('#profileName').textContent=name;$('#profileAge').textContent=age;
    $('#startScreen').style.display='none';$('#app').classList.remove('hidden');chatEl.innerHTML='';
    addMsg({from:'ai',text:`Hello ${name}! Welcome to Adventure English üéâ [TRANSLATION] Ol√° ${name}! Bem-vindo(a) ao Adventure English üéâ`,translate:true,speak:true});
  });
  try{const SR=window.SpeechRecognition||window.webkitSpeechRecognition;if(SR){recognition=new SR();recognition.lang='en-US';recognition.continuous=false;recognition.interimResults=false;recognition.onstart=()=>{recognizing=true;$('#micStatus').textContent='Ouvindo...';$('#btnMic').textContent='‚èπÔ∏è';};recognition.onend=()=>{recognizing=false;$('#micStatus').textContent='Microfone pronto';$('#btnMic').textContent='üé§';};recognition.onerror=e=>{$('#micStatus').textContent='Erro no microfone.';console.error('Mic error:',e.error);};recognition.onresult=e=>{const text=e.results[0][0].transcript;msgInput.value=text;handleSend(text);};$('#btnMic').addEventListener('click',()=>{if(!recognition)return;if(!recognizing){recognition.start();}else{recognition.stop();}});}}catch(err){$('#micStatus').textContent='Fala n√£o suportada.';}
}
function init(){
  const savedName=localStorage.getItem('ae_name'),savedAge=localStorage.getItem('ae_age');
  if(savedName&&savedAge){
    state.userName=savedName;state.age=savedAge;$('#profileName').textContent=savedName;$('#profileAge').textContent=savedAge;
    $('#startScreen').style.display='none';$('#app').classList.remove('hidden');
    addMsg({from:'ai',text:`Welcome back, ${savedName}! Let's continue! üòä [TRANSLATION] Bem-vindo(a) de volta, ${savedName}! Vamos continuar! üòä`,translate:true,speak:true});
  }else{
    $('#startScreen').style.display='flex';$('#app').classList.add('hidden');
  }
  renderScenes();renderCategories();renderVocab();renderMissions();setStars(0);renderBadges();
  $('#activeSceneName').textContent='Escolha uma cena';$('#currentVoice').textContent='Nenhuma';
  setupEventListeners();
}
init();
</script>
</body>
</html>
