<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Adventure English - Jogo de Conversa√ß√£o</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --bg1:#a5b4fc; --bg2:#fbcfe8; --bg3:#fef3c7;
    }
    html,body{ height:100%; }
    body{ font-family:'Nunito',system-ui, -apple-system; background: linear-gradient(180deg,#f0f9ff 0%, #fff 100%); color:#0f172a; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    #startScreen{ position:fixed; inset:0; background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3)); display:flex; align-items:center; justify-content:center; z-index:60; flex-direction:column; overflow:hidden; }
    .balloon{ position:absolute; bottom:-140px; width:64px; height:86px; border-radius:50% 50% 45% 55%; box-shadow:0 6px 18px rgba(0,0,0,0.08); transform-origin:center bottom; animation:float 10s linear infinite; opacity:.95; }
    @keyframes float{ 0%{ transform:translateY(0) rotate(0deg); } 100%{ transform:translateY(-130vh) rotate(16deg); opacity:0; } }
    .card{ background: rgba(255,255,255,0.92); backdrop-filter: blur(6px); }
    .bubble-ai::after, .bubble-kid::after{ content:""; position:absolute; bottom:-6px; width:0; height:0; border:8px solid transparent; }
    .bubble-ai::after{ left:16px; border-top-color: rgba(255,255,255,.95); }
    .bubble-kid::after{ right:16px; border-top-color: rgba(255,255,255,.95); }
    .nice-scroll::-webkit-scrollbar{ width:10px; } .nice-scroll::-webkit-scrollbar-thumb{ background:linear-gradient(180deg,#60a5fa,#a78bfa); border-radius:8px; }
    .nice-scroll{ scrollbar-width: thin; scrollbar-color:#a78bfa transparent; }
    .vocab-card { transform-style: preserve-3d; transition: transform 0.6s; }
    .vocab-card.flipped { transform: rotateY(180deg); }
    .card-front, .card-back {
        backface-visibility: hidden; position: absolute; top: 0; left: 0;
        width: 100%; height: 100%; display: flex; align-items: center;
        justify-content: center; padding: 1rem; border-radius: 0.75rem;
    }
    .card-back { transform: rotateY(180deg); background: rgba(255,255,255,0.92); color: #0f172a; font-weight: bold; }

    /* Anima√ß√£o da Medalha */
    @keyframes medal-in {
      0% { transform: scale(0.8) translateY(20px); opacity: 0; }
      100% { transform: scale(1) translateY(0); opacity: 1; }
    }
    #medalModal.visible { opacity: 1; }
    #medalModal.visible #medalCard { animation: medal-in 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }

    /* Estilos dos Jogos */
    .game-button.active { background-color: #6d28d9; color: white; }
    .game-option.selected { transform: scale(1.08); box-shadow: 0 0 0 3px #6d28d9; background-color: #f5d0fe; }
    .game-option.correct { box-shadow: 0 0 0 3px #16a34a; background-color: #dcfce7; }
    .game-option.incorrect { box-shadow: 0 0 0 3px #dc2626; background-color: #fee2e2; animation: shake 0.5s; }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    .memory-card { transform-style: preserve-3d; transition: transform 0.5s; cursor: pointer; }
    .memory-card .front, .memory-card .back { backface-visibility: hidden; position: absolute; top:0; left:0; width:100%; height:100%; display:flex; justify-content:center; align-items:center; }
    .memory-card .back { transform: rotateY(180deg); }
    .memory-card.flipped { transform: rotateY(180deg); }
  </style>
</head>
<body>

  <!-- START / ONBOARD -->
  <div id="startScreen">
    <div class="z-10 text-center px-6">
      <h1 class="text-4xl md:text-5xl font-extrabold text-white drop-shadow-lg mb-2">Adventure English üéà</h1>
      <p class="text-white/90 mb-6">Diga-nos seu nome e idade para come√ßar a aventura!</p>
      <div class="space-y-3">
        <input id="startName" type="text" placeholder="Seu nome (ex: Ana)" class="w-72 md:w-96 px-4 py-3 rounded-2xl text-center outline-none" />
        <input id="startAge" type="number" placeholder="Sua idade" min="5" max="12" class="w-72 md:w-96 px-4 py-3 rounded-2xl text-center outline-none" />
        <div class="flex gap-3 justify-center mt-3">
          <button id="btnStart" class="px-6 py-3 rounded-2xl bg-violet-600 text-white font-bold hover:bg-violet-700">Come√ßar üöÄ</button>
        </div>
      </div>
    </div>
    <div class="balloon" style="left:8%; background:linear-gradient(180deg,#fff,#f472b6); animation-delay:0s; transform:scale(0.9);"></div>
    <div class="balloon" style="left:28%; background:linear-gradient(180deg,#fff,#60a5fa); animation-delay:1.5s; transform:scale(1.1);"></div>
  </div>

  <!-- APP (hidden until onboarding) -->
  <div id="app" class="hidden max-w-7xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="h-12 w-12 rounded-2xl flex items-center justify-center text-2xl shadow-lg bg-gradient-to-br from-sky-400 to-violet-400 text-white">üá¨üáßüéà</div>
        <div>
          <h1 class="text-2xl md:text-3xl font-extrabold">Adventure English</h1>
          <p class="text-sm md:text-base text-slate-600">Jogo de conversa√ß√£o com IA (crian√ßas 5‚Äì12)</p>
        </div>
      </div>
      <div class="flex items-center gap-6">
        <!-- Navega√ß√£o de Views -->
        <div class="flex items-center gap-2 p-1 bg-slate-200 rounded-xl">
            <button id="viewToggleConversation" class="px-4 py-1.5 text-sm font-bold bg-white text-violet-600 rounded-lg shadow">üí¨ Conversa√ß√£o</button>
            <button id="viewToggleVocabulary" class="px-4 py-1.5 text-sm font-bold text-slate-600 rounded-lg">üìö Vocabul√°rio</button>
            <button id="viewToggleGames" class="px-4 py-1.5 text-sm font-bold text-slate-600 rounded-lg">üéÆ Jogos</button>
        </div>
        <div class="flex items-center gap-3">
            <label class="flex items-center gap-2 text-xs">
              <input id="translateToggle" type="checkbox" class="accent-fuchsia-500">
              Mostrar ajuda
            </label>
            <button id="testVoiceBtn" class="px-3 py-2 rounded-xl bg-sky-200 text-sky-900 text-sm">üîä Ouvir voz</button>
        </div>
      </div>
    </header>

    <!-- VIEW DE CONVERSA√á√ÉO -->
    <div id="conversationView">
        <main class="grid lg:grid-cols-3 gap-6 mt-6">
          <section class="lg:col-span-2 card rounded-2xl p-0 shadow-lg flex flex-col">
            <div class="flex items-center justify-between px-4 pt-4">
              <div><p id="activeSceneName" class="font-bold">Escolha uma cena</p><p class="text-xs text-slate-600">Dica: use frases curtas e emojis!</p></div>
              <div class="flex items-center gap-3">
                <button id="btnClear" class="text-xs px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200">Limpar chat</button>
                <button id="btnReset" class="text-xs px-3 py-2 rounded-lg bg-red-100 text-red-700 hover:bg-red-200">Reiniciar</button>
              </div>
            </div>
            <div id="chat" class="flex-1 px-4 pb-4 overflow-y-auto nice-scroll space-y-3 min-h-[400px]"></div>
            <form id="chatForm" class="border-t border-slate-100 p-3 flex items-end gap-2">
              <button type="button" id="btnHint" class="px-3 py-2 rounded-xl bg-amber-200 text-amber-900 font-bold hover:bg-amber-300">Dica üí°</button>
              <div class="flex-1">
                <textarea id="msgInput" rows="1" placeholder="Fale ou escreva em ingl√™s..." class="w-full resize-none rounded-xl border border-slate-200 px-3 py-2 outline-none focus:ring-2 focus:ring-violet-300"></textarea>
                <div class="flex items-center gap-2 mt-2">
                  <button type="button" id="btnMic" class="px-3 py-2 rounded-xl bg-emerald-500 text-white font-bold hover:bg-emerald-600">üé§ Falar</button>
                  <span id="micStatus" class="text-xs text-slate-600 font-medium"></span>
                </div>
              </div>
              <button id="btnSend" class="px-4 py-2 rounded-xl bg-violet-500 text-white font-extrabold hover:bg-violet-600">Enviar ‚ñ∂</button>
            </form>
          </section>
          <aside class="space-y-6">
             <section class="card rounded-2xl p-4 shadow-lg">
                <h3 class="font-extrabold mb-3">Cenas de Roleplay</h3>
                <div id="sceneList" class="grid grid-cols-2 gap-3"></div>
             </section>
             <section id="profile-card" class="card rounded-2xl p-4 shadow-lg">
               <div class="flex items-center justify-between">
                <div>
                  <h2 class="font-extrabold">Seu Perfil</h2>
                  <p id="profileDisplayName" class="text-lg font-bold text-violet-700"></p>
                </div>
                <button id="editProfile" class="px-3 py-2 rounded-xl bg-amber-200 text-amber-900 text-sm">Editar</button>
              </div>
            </section>
            <section class="card rounded-2xl p-4 shadow-lg">
              <div class="flex items-center justify-between mb-3"><h3 class="font-extrabold">Progresso ‚≠ê</h3><div id="levelBadge" class="text-xs font-extrabold text-slate-900 px-2 py-1 rounded-lg">N√≠vel 1</div></div>
              <div class="flex items-center gap-2"><div id="stars" class="flex text-2xl">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</div><span id="xpText" class="text-xs text-slate-600">0/5</span></div>
            </section>
             <section class="card rounded-2xl p-4 shadow-lg">
              <h3 class="font-extrabold mb-2">Voz atual üé§</h3><p id="currentVoice" class="text-sm text-slate-700">Nenhuma</p>
              <div class="mt-3"><label class="text-xs text-slate-600">Escolher voz</label><select id="voiceSelect" class="w-full mt-1 rounded-xl border border-slate-200 px-3 py-2"><option value="">(usar voz da cena)</option><option value="nova">Nova</option><option value="alloy">Alloy</option><option value="shimmer">Shimmer</option><option value="onyx">Onyx</option><option value="fable">Fable</option><option value="echo">Echo</option></select></div>
            </section>
            <section class="card rounded-2xl p-4 shadow-lg"><h3 class="font-extrabold mb-2">Medalhas üèÖ</h3><div id="badges" class="flex flex-wrap gap-2"></div></section>
          </aside>
        </main>
    </div>

    <!-- VIEW DE VOCABUL√ÅRIO -->
    <div id="vocabularyView" class="hidden">
        <div class="card rounded-2xl p-6 shadow-lg mt-6">
            <div class="flex items-center justify-between mb-3"><h3 class="font-extrabold text-2xl">Categorias essenciais</h3><div class="text-xs text-slate-600">Selecione uma para ver vocabul√°rio</div></div>
            <div id="catList" class="flex flex-wrap gap-2 mb-4"></div>
            <div class="grid md:grid-cols-3 gap-6 mt-6 pt-6 border-t">
              <div class="md:col-span-2"><h4 class="font-bold mb-2">Vocabul√°rio</h4><div id="vocab" class="grid grid-cols-2 sm:grid-cols-4 gap-3"></div></div>
              <div class="space-y-6">
                <div><h4 class="font-bold mb-2">Miss√µes üéØ</h4><ul id="missions" class="list-disc pl-5 space-y-1 text-sm"></ul></div>
                <div><h4 class="font-bold mb-2">Frases de Exemplo üó£Ô∏è</h4><ul id="example-sentences" class="list-disc pl-5 space-y-2 text-sm"></ul></div>
              </div>
            </div>
        </div>
    </div>

    <!-- VIEW DE JOGOS -->
    <div id="gamesView" class="hidden">
        <div class="card rounded-2xl p-6 shadow-lg mt-6">
            <h2 class="text-2xl font-extrabold mb-4">Central de Jogos üéÆ</h2>
            <div id="game-nav" class="flex flex-wrap items-center justify-center gap-2 mb-6">
                <button class="game-button px-4 py-2 text-sm font-bold bg-slate-200 text-slate-700 rounded-xl" data-game="wordEmoji">Ligar Palavra-Emoji</button>
                <button class="game-button px-4 py-2 text-sm font-bold bg-slate-200 text-slate-700 rounded-xl" data-game="memory">Jogo da Mem√≥ria</button>
                <button class="game-button px-4 py-2 text-sm font-bold bg-slate-200 text-slate-700 rounded-xl" data-game="scramble">Letras Baralhadas</button>
                <button class="game-button px-4 py-2 text-sm font-bold bg-slate-200 text-slate-700 rounded-xl" data-game="missing">O que Falta?</button>
                <button class="game-button px-4 py-2 text-sm font-bold bg-slate-200 text-slate-700 rounded-xl" data-game="oddOneOut">O Intruso</button>
            </div>
            
            <div id="gameContainer" class="p-4 bg-slate-100/50 rounded-2xl min-h-[400px] relative">
                <p id="gameFeedback" class="text-center text-sm h-5 mb-4 font-bold"></p>
                
                <!-- Jogo: Ligar Palavra-Emoji -->
                <div id="wordEmojiGame" class="game-area hidden">
                    <p class="font-bold text-center mb-4">Ligue a palavra em ingl√™s com o emoji correto!</p>
                    <div class="grid grid-cols-2 gap-6 max-w-2xl mx-auto">
                        <div id="gameWordsContainer" class="grid grid-cols-1 gap-3"></div>
                        <div id="gameEmojisContainer" class="grid grid-cols-3 gap-3"></div>
                    </div>
                </div>
                <!-- Jogo da Mem√≥ria -->
                <div id="memoryGame" class="game-area hidden">
                     <p class="font-bold text-center mb-4">Encontre os pares de palavras e emojis!</p>
                    <div id="memoryGameBoard" class="grid grid-cols-4 gap-4 max-w-md mx-auto"></div>
                </div>
                <!-- Letras Baralhadas -->
                <div id="scrambleGame" class="game-area hidden">
                    <p class="font-bold text-center mb-4">Coloque as letras na ordem correta para formar a palavra!</p>
                    <div class="flex flex-col items-center justify-center">
                        <div id="scrambleEmoji" class="text-7xl mb-4"></div>
                        <div id="scrambleAnswer" class="h-12 w-64 bg-white rounded-lg border-2 border-slate-300 flex items-center justify-center text-2xl font-bold tracking-widest mb-4"></div>
                        <div id="scrambleLetters" class="flex gap-2 mb-4"></div>
                        <button id="scrambleClearBtn" class="text-xs text-slate-500 hover:underline">Limpar</button>
                    </div>
                </div>
                <!-- O que Falta? -->
                <div id="missingGame" class="game-area hidden">
                    <p id="missingGameInstruction" class="font-bold text-center mb-4">Memorize os emojis... e descubra qual est√° em falta!</p>
                    <div class="flex flex-col items-center justify-center">
                        <div id="missingEmojisContainer" class="flex justify-center items-center gap-4 h-32"></div>
                         <div id="missingAnswer" class="h-12 w-64 bg-white rounded-lg border-2 border-slate-300 flex items-center justify-center text-2xl font-bold tracking-widest my-4"></div>
                        <div id="gameHintContainer" class="h-10 mb-2"></div>
                        <div id="missingLetters" class="flex flex-wrap justify-center gap-2 mb-4"></div>
                    </div>
                </div>
                <!-- O Intruso -->
                <div id="oddOneOutGame" class="game-area hidden">
                    <p class="font-bold text-center mb-4">Qual destes n√£o pertence ao grupo? Escreva o nome em ingl√™s!</p>
                     <div class="flex flex-col items-center justify-center">
                        <div id="oddOneOutEmojis" class="flex justify-center items-center gap-4 text-5xl h-24"></div>
                         <div id="oddOneOutAnswer" class="h-12 w-64 bg-white rounded-lg border-2 border-slate-300 flex items-center justify-center text-2xl font-bold tracking-widest my-4"></div>
                        <div id="oddOneOutLetters" class="flex flex-wrap justify-center gap-2 mb-4"></div>
                    </div>
                </div>
                
                <div id="gameWinMessage" class="hidden text-center mt-6">
                    <p class="text-2xl font-bold text-emerald-600">üéâ Voc√™ conseguiu! üéâ</p>
                    <button id="playAgainBtn" class="mt-4 px-6 py-2 bg-emerald-500 text-white font-bold rounded-xl">Jogar Novamente</button>
                </div>
            </div>
        </div>
    </div>
  </div>

  <div id="confirmModal" class="fixed inset-0 bg-slate-900 bg-opacity-60 hidden items-center justify-center p-4 z-70">
    <div class="bg-white rounded-2xl p-6 shadow-xl max-w-sm w-full">
      <h3 class="font-extrabold text-xl mb-2">Reiniciar Progresso?</h3><p class="text-slate-600 text-sm mb-4">Esta a√ß√£o apagar√° todo o seu progresso.</p>
      <div class="flex justify-end gap-3"><button id="cancelReset" class="px-4 py-2 rounded-xl bg-slate-200 font-bold hover:bg-slate-300">Cancelar</button><button id="confirmReset" class="px-4 py-2 rounded-xl bg-red-500 text-white font-bold hover:bg-red-600">Confirmar</button></div>
    </div>
  </div>

  <!-- Medal Unlocked Animation -->
  <div id="medalModal" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center p-4 z-[80] transition-opacity duration-300 opacity-0">
    <div id="medalCard" class="bg-white rounded-3xl p-6 shadow-xl max-w-sm w-full text-center transform scale-90 opacity-0 transition-all duration-300">
      <div id="medalEmoji" class="text-7xl mb-4 animate-bounce"></div>
      <h2 class="text-2xl font-extrabold text-amber-500 mb-2">Parab√©ns!</h2>
      <p class="text-slate-700 font-bold text-lg mb-1">Voc√™ ganhou a medalha:</p>
      <p id="medalName" class="font-bold text-xl text-violet-600"></p>
      <p id="medalDesc" class="text-sm text-slate-500 mt-2"></p>
      <button id="closeMedalModal" class="mt-6 px-5 py-2 bg-slate-200 text-slate-800 font-bold rounded-xl hover:bg-slate-300">Fechar</button>
    </div>
  </div>

<script>
/* =========================
   CONFIGURA√á√ÉO
   ========================= */
const BACKEND_URL = ''; 

const state = {
  sceneId: null, categoryId: null, stars: 0, level: 1, showTranslation: false, history: [],
  achievements: {}, userName: null, age: null, voice: null, currentAudio: null, vocabExpanded: {},
  currentGame: { id: null, selectedWord: null, selectedEmoji: null, pairsLeft: 0, flippedCards: [], lockBoard: false }
};

/* ---------- DADOS (CENAS, CATEGORIAS, VOCABUL√ÅRIO) ---------- */
const scenes = [
  { id:'teacher', name:'Professora Daisy', nameEn:'Teacher Daisy', icon:'üßë‚Äçüè´', style:'calma, encorajadora', persona: 'Your name is Mrs. Daisy. You are a kind and patient teacher. Ask the child about their day at school, their favorite subject, and what they like to read.'},
  { id:'zoo', name:'Guia do Zoo Leo', nameEn:'Zoo Guide Leo', icon:'ü¶Å', style:'curioso, divertido', persona: 'Your name is Leo, a 25-year-old zoo guide who loves animals. Share fun facts about animals and ask the child about their favorites. Make animal sounds.'},
  { id:'restaurant', name:'Gar√ßom Sam', nameEn:'Waiter Sam', icon:'üçΩÔ∏è', style:'educado, paciente', persona: 'Your name is Sam, a friendly waiter. Welcome the child to your restaurant, ask for their order, and suggest delicious food from the menu.'},
  { id:'doctor', name:'M√©dica Isabella', nameEn:'Doctor Isabella', icon:'ü©∫', style:'gentil, cuidadosa', persona: 'You are Dr. Isabella, a caring doctor. Ask the child how they are feeling. If they mention pain, offer simple, comforting advice like resting or drinking water. Never give real medical advice.' },
  { id:'shop', name:'Vendedora Chloe', nameEn:'Seller Chloe', icon:'üõçÔ∏è', style:'prestativa, alegre', persona: 'Your name is Chloe, a cheerful teenager working at a clothing store. Help the child pick out clothes, compliment their choices, and ask about their favorite colors.'},
  { id:'playground', name:'Amiga Lily', nameEn:'Playground Friend Lily', icon:'üõù', style:'brincalhona, animada', persona: 'Your name is Lily. You are the same age as the child you are talking to. Be very playful and energetic. Invite them to play on the swings, slides, and talk about your favorite games.'},
];
const sceneVoices = { teacher: "nova", zoo: "alloy", restaurant: "shimmer", doctor: "nova", shop: "shimmer", playground: "nova" };
const categories = [
    { id:'greetings', icon:'üëã', name:'Sauda√ß√µes', englishName: 'Greetings', missions:['Apresente-se: ‚ÄúHello! My name is __.‚Äù','Pergunte o nome: ‚ÄúWhat is your name?‚Äù'], vocab:[['hello', 'ol√°'], ['goodbye', 'tchau'], ['please', 'por favor'], ['thank you', 'obrigado(a)'], ['sorry', 'desculpa'], ['name', 'nome'], ['how are you?', 'como voc√™ est√°?'], ['my name is...', 'meu nome √©...'], ['see you later', 'at√© mais tarde'], ['yes', 'sim'], ['no', 'n√£o'], ['good morning', 'bom dia'], ['good afternoon', 'boa tarde'], ['good night', 'boa noite'], ['excuse me', 'com licen√ßa'], ["you're welcome", 'de nada'], ['nice to meet you', 'prazer em conhecer'], ['friend', 'amigo(a)'], ['boy', 'menino'], ['girl', 'menina'], ['what is this?', 'o que √© isto?'], ['I understand', 'eu entendo'], ["I don't know", 'eu n√£o sei'], ['can you help me?', 'pode me ajudar?'], ['of course', 'claro'], ['maybe', 'talvez'], ['welcome', 'bem-vindo(a)'], ['have a good day', 'tenha um bom dia'], ['take care', 'se cuida'], ['me too', 'eu tamb√©m'], ['why', 'por qu√™'], ['because', 'porque'], ['now', 'agora'], ['later', 'mais tarde'], ['today', 'hoje'], ['tomorrow', 'amanh√£']], examples: ['**Hello**, how are you?', '**Thank you** for the gift.','**Sorry**, I am late.'] },
    { id:'numbers', icon:'üî¢', name:'N√∫meros', englishName: 'Numbers', missions:['Conte at√© cinco.','Diga sua idade.'], vocab:[['one', 'um'], ['two', 'dois'], ['three', 'tr√™s'], ['four', 'quatro'], ['five', 'cinco'], ['six', 'seis'], ['seven', 'sete'], ['eight', 'oito'], ['nine', 'nove'], ['ten', 'dez'], ['eleven', 'onze'], ['twelve', 'doze'], ['thirteen', 'treze'], ['fourteen', 'catorze'], ['fifteen', 'quinze'], ['sixteen', 'dezesseis'], ['seventeen', 'dezessete'], ['eighteen', 'dezoito'], ['nineteen', 'dezenove'], ['twenty', 'vinte']], examples: ['I have **one** dog.', 'She is **six** years old.'] },
    { id:'colors', icon:'üé®', name:'Cores', englishName: 'Colors', missions:['Fale sua cor favorita.'], vocab:[['red', 'vermelho'], ['blue', 'azul'], ['green', 'verde'], ['yellow', 'amarelo'], ['pink', 'rosa'], ['orange', 'laranja'], ['purple', 'roxo'], ['black', 'preto'], ['white', 'branco'], ['brown', 'marrom'], ['gray', 'cinza'], ['rainbow', 'arco-√≠ris'], ['color', 'cor'], ['dark', 'escuro'], ['light', 'claro'], ['bright', 'brilhante']], examples: ['My favorite color is **blue**.', 'The sun is **yellow**.'] },
    { id:'animals', icon:'üêæ', name:'Animais', englishName: 'Animals', missions:['Qual seu animal favorito?'], vocab:[['cat', 'gato'], ['dog', 'cachorro'], ['bird', 'p√°ssaro'], ['fish', 'peixe'], ['lion', 'le√£o'], ['monkey', 'macaco'], ['bear', 'urso'], ['tiger', 'tigre'], ['snake', 'cobra'], ['rabbit', 'coelho'], ['horse', 'cavalo'], ['cow', 'vaca'], ['pig', 'porco'], ['sheep', 'ovelha'], ['chicken', 'frango/galinha'], ['duck', 'pato'], ['frog', 'sapo'], ['bee', 'abelha'], ['butterfly', 'borboleta'], ['spider', 'aranha']], examples: ['The **cat** is sleeping.', 'I love my **dog**!'] },
    { id:'food', icon:'üçé', name:'Comida', englishName: 'Food', missions:['Diga o que gosta de comer.'], vocab:[['apple', 'ma√ß√£'], ['banana', 'banana'], ['milk', 'leite'], ['water', '√°gua'], ['bread', 'p√£o'], ['pizza', 'pizza'], ['cake', 'bolo'], ['juice', 'suco'], ['cheese', 'queijo'], ['egg', 'ovo'], ['rice', 'arroz'], ['ice cream', 'sorvete'], ['strawberry', 'morango'], ['grapes', 'uvas'], ['watermelon', 'melancia'], ['carrot', 'cenoura'], ['tomato', 'tomate'], ['potato', 'batata']], examples: ['I want an **apple**, please.', 'Do you like **pizza**?'] },
    { id:'family', icon:'üë®‚Äçüë©‚Äçüëß', name:'Fam√≠lia', englishName: 'Family', missions:['Fale sobre sua m√£e ou pai.'], vocab:[['mother', 'm√£e'], ['father', 'pai'], ['brother', 'irm√£o'], ['sister', 'irm√£'], ['baby', 'beb√™'], ['friend', 'amigo(a)'], ['grandmother', 'av√≥'], ['grandfather', 'av√¥'], ['aunt', 'tia'], ['uncle', 'tio'], ['cousin', 'primo(a)'], ['son', 'filho'], ['daughter', 'filha'], ['parents', 'pais'], ['children', 'crian√ßas/filhos'], ['man', 'homem'], ['woman', 'mulher'], ['person', 'pessoa'], ['people', 'pessoas']], examples: ['This is my **mother**.', 'My **friend** is funny.'] },
    { id:'clothes', icon:'üëï', name:'Roupas', englishName: 'Clothes', missions:['Descreva sua roupa.'], vocab:[['shirt', 'camisa'], ['pants', 'cal√ßas'], ['shoes', 'sapatos'], ['dress', 'vestido'], ['hat', 'chap√©u'], ['jacket', 'jaqueta'], ['socks', 'meias'], ['skirt', 'saia'], ['sweater', 'su√©ter'], ['coat', 'casaco'], ['t-shirt', 'camiseta'], ['jeans', 'cal√ßa jeans'], ['boots', 'botas'], ['sandals', 'sand√°lias'], ['gloves', 'luvas'], ['scarf', 'cachecol'], ['cap', 'bon√©'], ['belt', 'cinto']], examples: ['I like your **shirt**.', 'Where are my **shoes**?'] },
    { id:'body', icon:'üß†', name:'Corpo', englishName: 'Body', missions:['Aponte para sua cabe√ßa.'], vocab:[['head', 'cabe√ßa'], ['hand', 'm√£o'], ['leg', 'perna'], ['eyes', 'olhos'], ['nose', 'nariz'], ['mouth', 'boca'], ['ear', 'orelha'], ['hair', 'cabelo'], ['arm', 'bra√ßo'], ['foot', 'p√©'], ['finger', 'dedo da m√£o'], ['toe', 'dedo do p√©'], ['back', 'costas'], ['stomach', 'barriga'], ['chest', 'peito'], ['shoulder', 'ombro'], ['neck', 'pesco√ßo'], ['face', 'rosto'], ['teeth', 'dentes'], ['tongue', 'l√≠ngua']], examples: ['My **head** hurts.', 'She has blue **eyes**.'] },
    { id:'weather', icon:'‚õÖ', name:'Tempo', englishName: 'Weather', missions:['Descreva o dia de hoje.'], vocab:[['sunny', 'ensolarado'], ['rainy', 'chuvoso'], ['cold', 'frio'], ['hot', 'quente'], ['snow', 'neve'], ['wind', 'vento'], ['cloud', 'nuvem'], ['storm', 'tempestade'], ['fog', 'nevoeiro'], ['ice', 'gelo'], ['temperature', 'temperatura'], ['degree', 'grau'], ['season', 'esta√ß√£o'], ['spring', 'primavera'], ['summer', 'ver√£o'], ['autumn', 'outono'], ['winter', 'inverno']], examples: ['It is **sunny** today.', 'I don\'t like **rainy** days.'] },
    { id:'shapes', icon:'üí†', name:'Formatos', englishName: 'Shapes', missions:['Desenhe um c√≠rculo no ar.', 'Qual √© a sua forma geom√©trica favorita?'], vocab:[['circle', 'c√≠rculo'], ['square', 'quadrado'], ['triangle', 'tri√¢ngulo'], ['star', 'estrela'], ['heart', 'cora√ß√£o'], ['rectangle', 'ret√¢ngulo'], ['oval', 'oval'], ['diamond', 'losango'], ['shape', 'forma'], ['line', 'linha'], ['dot', 'ponto'], ['side', 'lado'], ['corner', 'canto'], ['big', 'grande'], ['small', 'pequeno'], ['long', 'longo'], ['short', 'curto'], ['round', 'redondo'], ['straight', 'reto']], examples: ['The moon is a **circle**.', 'A window is a **square**.'] },
];
const gameVocab = {
    'animals': [['cat','üê±'], ['dog','üê∂'], ['bird','üê¶'], ['fish','üê†'], ['lion','ü¶Å'], ['monkey','üêµ'], ['bear', 'üêª'], ['frog', 'üê∏'], ['tiger', 'üêØ'], ['rabbit', 'üê∞'], ['pig', 'üê∑'], ['cow', 'üêÆ']],
    'food': [['apple','üçé'], ['banana','üçå'], ['pizza','üçï'], ['milk','ü•õ'], ['bread','üçû'], ['cake', 'üç∞'], ['grapes', 'üçá'], ['cheese', 'üßÄ'], ['egg', 'ü•ö'], ['carrot', 'ü•ï'], ['strawberry', 'üçì'], ['ice cream', 'üç¶']],
    'colors': [['red','üî¥'], ['blue','üîµ'], ['green','üü¢'], ['yellow','üü°'], ['orange','üü†'], ['purple','üü£'], ['black', '‚ö´Ô∏è'], ['white', '‚ö™Ô∏è'], ['pink', 'üå∏'], ['brown', 'üü´'], ['gray', 'üêò']],
    'shapes': [['circle','üîµ'], ['square','üü™'], ['triangle','üî∫'], ['star','‚≠ê'], ['heart','‚ù§Ô∏è'], ['rectangle', '‚ñ≠']],
    'clothes': [['shirt', 'üëï'], ['pants', 'üëñ'], ['dress', 'üëó'], ['hat', 'üëí'], ['shoes', 'üëü'], ['socks', 'üß¶']],
    'body': [['head', 'üß†'], ['hand', 'üñêÔ∏è'], ['eyes', 'üëÄ'], ['nose', 'üëÉ'], ['mouth', 'üëÑ'], ['leg', 'ü¶µ']],
    'weather': [['sunny', '‚òÄÔ∏è'], ['rainy', 'üåßÔ∏è'], ['cold', 'ü•∂'], ['hot', 'ü•µ'], ['snow', '‚ùÑÔ∏è'], ['wind', 'üå¨Ô∏è']]
};
const oddOneOutSets = [
    { emojis: ['üçé', 'üçå', 'üê∂', 'üçä'], odd_one_emoji: 'üê∂', answer: 'dog' },
    { emojis: ['üöó', 'üö≤', 'üöÄ', '‚≠ê'], odd_one_emoji: '‚≠ê', answer: 'star' },
    { emojis: ['‚öΩ', 'üèÄ', 'üèà', 'üëë'], odd_one_emoji: 'üëë', answer: 'crown' },
    { emojis: ['üëï', 'üëñ', '‚òÄÔ∏è', 'üëó'], odd_one_emoji: '‚òÄÔ∏è', answer: 'sun' },
    { emojis: ['üîµ', 'üü™', 'üî∫', 'üê±'], odd_one_emoji: 'üê±', answer: 'cat' },
    { emojis: ['üñêÔ∏è', 'üëÄ', 'üëÉ', 'üß¢'], odd_one_emoji: 'üß¢', answer: 'cap' },
    { emojis: ['ü•∂', 'ü•µ', '‚ùÑÔ∏è', 'üçï'], odd_one_emoji: 'üçï', answer: 'pizza' },
    { emojis: ['1Ô∏è‚É£', '2Ô∏è‚É£', 'üÖ∞Ô∏è', '3Ô∏è‚É£'], odd_one_emoji: 'üÖ∞Ô∏è', answer: 'a' }
];


/* ---------- UTILIT√ÅRIOS ---------- */
const $ = sel => document.querySelector(sel);
const chatEl = $('#chat'); const msgInput = $('#msgInput');
function scrollBottom(){ chatEl.scrollTo({ top: chatEl.scrollHeight, behavior: 'smooth' }); }
function shuffle(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }


/* ---------- √ÅUDIO E SONS ---------- */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSynth({type='sine', freq=600, length=0.08, gain=0.08, glide=false}){ try{ const o=audioCtx.createOscillator(),g=audioCtx.createGain(),d=audioCtx.currentTime; o.type=type; o.frequency.setValueAtTime(freq,d); g.gain.setValueAtTime(gain,d); if(glide){o.frequency.exponentialRampToValueAtTime(freq*1.6,d+length)} o.connect(g);g.connect(audioCtx.destination);o.start(d);o.stop(d+length) }catch(e){} }
function playPop(){ playSynth({type:'triangle', freq:800, length:0.08, gain:0.06}); }
function playCorrect(){ playSynth({type:'sine', freq:800, length:0.1, gain:0.08, glide:true}); }
function playWrong(){ playSynth({type:'square', freq:200, length:0.15, gain:0.05}); }
function playAchievementSound(){ playSynth({type:'sine', freq:523.25, length:0.1, gain:0.08}); setTimeout(()=>playSynth({type:'sine', freq:659.25, length:0.1, gain:0.08}), 120); setTimeout(()=>playSynth({type:'sine', freq:783.99, length:0.1, gain:0.08}), 240); setTimeout(()=>playSynth({type:'sine', freq:1046.50, length:0.2, gain:0.1, glide:true}), 360); }
async function ttsSpeak(text, button = null) {
    if (state.currentAudio) { state.currentAudio.pause(); state.currentAudio.onended = null; state.currentAudio.src = ''; state.currentAudio = null; }
    if (audioCtx.state === 'suspended') { await audioCtx.resume().catch(()=>{}); }
    if (button) { button.disabled = true; button.textContent = 'üîÑ'; }
    const voiceToUse = $('#voiceSelect')?.value || state.voice || 'alloy';
    try {
        const res = await fetch(`${BACKEND_URL}/api/tts`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ input: text, voice: voiceToUse })
        });
        if (!res.ok) { throw new Error('TTS failed with status ' + res.status); }
        const blob = await res.blob();
        const newAudio = new Audio(URL.createObjectURL(blob));
        state.currentAudio = newAudio;
        await newAudio.play().catch(e => console.warn("Autoplay was blocked", e));
        newAudio.onended = () => {
            if (button && document.body.contains(button)) { button.disabled = false; button.textContent = 'üîä'; }
            if (state.currentAudio === newAudio) { state.currentAudio = null; }
        };
    } catch (err) {
        console.error("TTS Error:", err);
        addMsg({from:'ai', text:'Desculpe, tive um problema para gerar o √°udio. üîá', translate:false, speak:false});
        if (button) { button.disabled = false; button.textContent = 'üîä'; }
    }
}

/* ---------- UI: MENSAGENS, MEDALHAS, CENAS, ETC. ---------- */
function addMsg({from='ai', text, translate=true, speak=true}){
  const wrap=document.createElement('div');
  wrap.className=`relative flex ${from==='ai'?'justify-start':'justify-end'}`;
  const bubble=document.createElement('div');
  bubble.className=`relative max-w-[82%] px-4 py-3 rounded-2xl shadow card ${from==='ai'?'bubble-ai':'bubble-kid'}`;
  bubble.style.margin='6px 0';
  let englishText = text, portugueseText = null;
  if (from === 'ai' && text.includes('[TRANSLATION]')) {
    const parts = text.split('[TRANSLATION]');
    englishText = parts[0].trim();
    portugueseText = parts[1].trim();
  }
  const contentDiv=document.createElement('div');
  contentDiv.className='text-[15px] leading-relaxed';
  contentDiv.textContent = englishText;
  bubble.appendChild(contentDiv);
  if (state.showTranslation && from === 'ai' && portugueseText) {
    const t=document.createElement('div');
    t.className='text-[12px] text-slate-600 mt-1';
    t.textContent = `PT: ${portugueseText}`;
    bubble.appendChild(t);
  }
  if (from==='ai'){
    const controls=document.createElement('div');
    controls.style.marginTop='8px';
    const listenBtn=document.createElement('button');
    listenBtn.className='px-3 py-1 rounded-full text-xs bg-sky-100 hover:bg-sky-200 text-sky-900 font-bold';
    listenBtn.textContent='üîä Ouvir';
    listenBtn.onclick=()=>ttsSpeak(englishText, listenBtn);
    controls.appendChild(listenBtn);
    bubble.appendChild(controls);
    if(speak) ttsSpeak(englishText);
  }
  wrap.appendChild(bubble);
  chatEl.appendChild(wrap);
  scrollBottom();
}
function setStars(n){
  state.stars=n; $('#stars').textContent='‚òÖ'.repeat(n)+'‚òÜ'.repeat(5-n); $('#xpText').textContent=`${n}/5`;
  if(n>=5){ state.level++; $('#levelBadge').textContent=`N√≠vel ${state.level}`; giveMedal('five-stars'); setTimeout(()=>setStars(0),400); }
}
const medalDefs = [
  {id:'first-talk', label:'1¬™ conversa', emoji:'ü•á', descEn: "You sent your first message!", descPt: "Voc√™ enviou sua primeira mensagem!"},
  {id:'vocab-star', label:'Palavra do Tema', emoji:'üåü', descEn: "You used a word from the category!", descPt: "Voc√™ usou uma palavra da categoria!"},
  {id:'five-stars', label:'5 Estrelas', emoji:'‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê', descEn: "You earned 5 stars in a category!", descPt: "Voc√™ ganhou 5 estrelas em uma categoria!"},
  {id:'animal-fan', label:'Amigo dos Animais', emoji:'üêæ', descEn: "You talked about animals!", descPt: "Voc√™ falou sobre animais!"},
  {id:'polite-kid', label:'Crian√ßa Educada', emoji:'üôè', descEn: "You were very polite!", descPt: "Voc√™ foi muito educado(a)!"},
  {id:'curious-mind', label:'Mente Curiosa', emoji:'‚ùì', descEn: "You asked a question!", descPt: "Voc√™ fez uma pergunta!"},
  {id:'feeling-fine', label:'Expressivo', emoji:'üòä', descEn: "You talked about your feelings!", descPt: "Voc√™ falou sobre seus sentimentos!"}
];

function showMedalAnimation(medal) {
  const modal = $('#medalModal'), card = $('#medalCard'), emoji = $('#medalEmoji'), name = $('#medalName'), desc = $('#medalDesc');
  emoji.textContent = medal.emoji; name.textContent = medal.label; desc.textContent = `${medal.descEn} / ${medal.descPt}`;
  modal.classList.remove('hidden'); modal.classList.add('flex');
  setTimeout(() => { modal.classList.add('visible'); playAchievementSound(); }, 10);
  const hide = () => { modal.classList.remove('visible'); setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('flex'); }, 300); };
  const hideTimeout = setTimeout(hide, 5000);
  $('#closeMedalModal').onclick = () => { clearTimeout(hideTimeout); hide(); };
}
function renderBadges(){
  const box=$('#badges'); box.innerHTML='';
  medalDefs.forEach(m=>{
    const got=!!state.achievements[m.id];
    const b=document.createElement('div'); b.className=`px-3 py-2 rounded-xl border ${got?'border-emerald-300 bg-emerald-50 text-emerald-800':'border-slate-200 bg-white/70 text-slate-500'}`;
    b.innerHTML=`<span class="mr-1">${m.emoji}</span> <span class="font-bold">${m.label}</span>`; box.appendChild(b);
  });
}
function giveMedal(id){
  if(state.achievements[id])return;
  state.achievements[id] = true;
  renderBadges();
  const medal = medalDefs.find(m => m.id === id);
  if (medal) { showMedalAnimation(medal); }
}
function renderScenes(){
  const box=$('#sceneList'); box.innerHTML='';
  scenes.forEach(s=>{
    const btn=document.createElement('button'); btn.className='pick w-full text-left px-4 py-3 rounded-xl border border-slate-200 hover:border-violet-300 hover:bg-violet-50 transition';
    btn.innerHTML=`<div class="flex items-center gap-3"><div class="h-10 w-10 rounded-xl flex items-center justify-center text-2xl" style="background:linear-gradient(135deg,#60a5fa,#a78bfa);color:white;">${s.icon}</div><div><div class="font-extrabold">${s.name}</div><div class="text-xs text-slate-600">${s.style}</div></div></div>`;
    btn.addEventListener('click',()=>{
      state.sceneId=s.id; state.voice=sceneVoices[s.id]||'alloy'; $('#activeSceneName').textContent=s.name;
      [...box.children].forEach(c=>c.classList.remove('ring-2','ring-violet-400','bg-violet-50'));
      btn.classList.add('ring-2','ring-violet-400','bg-violet-50');
      $('#currentVoice').textContent=`Voz: ${state.voice}`;
      addMsg({from:'ai',text:`Hello! My name is ${s.nameEn.split(' ').pop()}! Let's talk! üòä [TRANSLATION] Ol√°! O meu nome √© ${s.name.split(' ').pop()}! Vamos conversar! üòä`,translate:true}); playPop();
    });
    box.appendChild(btn);
  });
}
function renderCategories(){
  const box=$('#catList'); box.innerHTML='';
  categories.forEach(c=>{
    const chip=document.createElement('button'); chip.className='pick px-3 py-2 rounded-full text-sm border border-slate-200 bg-white/70 hover:bg-white font-bold';
    chip.innerHTML=`${c.icon} ${c.name}`;
    chip.addEventListener('click',()=>{
      state.categoryId=c.id;
      [...box.children].forEach(ch=>ch.classList.remove('ring-2','ring-sky-400','bg-sky-50'));
      chip.classList.add('ring-2','ring-sky-400','bg-sky-50'); renderVocab(); renderMissions(); renderExamples();
    });
    box.appendChild(chip);
  });
}
function renderVocab() {
    const c = categories.find(x => x.id === state.categoryId);
    const box = $('#vocab');
    box.innerHTML = '';
    if (!c) {
        box.innerHTML = '<div class="text-sm text-slate-600 col-span-full">Escolha uma categoria.</div>';
        return;
    }
    c.vocab.forEach(([en, pt]) => {
        createVocabCard(en, pt, box);
    });
}
function createVocabCard(en, pt, container) {
    const card=document.createElement('div'); card.className='vocab-card w-full h-20 relative cursor-pointer'; card.style.perspective='1000px';
    const front=document.createElement('div'); front.className='card-front border border-slate-200 bg-white/80 hover:bg-white text-center'; front.innerHTML=`<div class="font-extrabold text-sm text-slate-800 capitalize">${en}</div>`;
    const back=document.createElement('div'); back.className='card-back border border-slate-200'; back.innerHTML=`<div class="font-bold text-sm text-slate-800 capitalize">${pt}</div>`;
    card.append(front,back); card.addEventListener('click',()=>{ card.classList.toggle('flipped'); ttsSpeak(en,null); if(card.classList.contains('flipped')){setTimeout(()=>card.classList.remove('flipped'),5000)} });
    container.appendChild(card);
}
function renderMissions(){
  const c=categories.find(x=>x.id===state.categoryId),ul=$('#missions'); ul.innerHTML='';
  if(!c){ ul.innerHTML='<li class="text-slate-600">Escolha uma categoria.</li>'; return; }
  c.missions.forEach(m=>{const li=document.createElement('li');li.className='text-slate-700';li.textContent=m.replace('__',state.userName||'...');ul.appendChild(li);});
}
function renderExamples() {
    const c = categories.find(x => x.id === state.categoryId);
    const ul = $('#example-sentences');
    ul.innerHTML = '';
    if (!c || !c.examples) {
        ul.innerHTML = '<li class="text-slate-600">-</li>';
        return;
    }
    c.examples.forEach(ex => {
        const li = document.createElement('li');
        li.className = 'text-slate-700';
        li.innerHTML = ex.replace(/\*\*(.*?)\*\*/g, '<strong class="font-black text-violet-600">$1</strong>');
        ul.appendChild(li);
    });
}

/* ---------- L√ìGICA DO CHAT COM BACKEND ---------- */
function getAgeGuidance(age){
  if(!age||age>9)return'Use simple English (A2 level). You can introduce a new word occasionally.';
  if(age<=6)return'Use extremely simple English (A0 level), with 1-4 word sentences and lots of emojis.';
  return'Use simple English (A1 level). Use short, clear sentences. Ask simple questions.';
}
function buildSystemPrompt() {
  const scene = scenes.find(s => s.id === state.sceneId);
  let persona_instruction = scene ? scene.persona : 'You are a friendly helper.';
  if (scene && scene.id === 'playground' && state.age) {
      persona_instruction = `Your name is Lily. You are ${state.age} years old, just like your new friend! Be very playful and energetic. Invite them to play on the swings, slides, and talk about your favorite games.`;
  }
  return `You are an AI acting as a character for a roleplay with a ${state.age || 'young'} year-old child named ${state.userName || 'friend'}.
**CHARACTER PERSONA: ${persona_instruction}**
**CORE INSTRUCTIONS:**
1.  **NEVER BREAK CHARACTER:** You are NOT an AI. You are the character described in your PERSONA. If the child asks your name, age, or personal questions, answer using your character's details. Fully embody the role.
2.  **GRAMMAR CORRECTION:** Your most important task is to help the child learn. If the child makes a CLEAR grammatical mistake (like "I drawed" instead of "I drew"), you MUST gently correct it and add a very short, simple explanation in parentheses. Example: "That's great! Remember, we say **'I drew a butterfly'** (because 'drew' is the past of 'draw'). Butterflies are so pretty!" If the child's sentence is correct, DO NOT rephrase it. Just praise them and continue the conversation naturally.
3.  **ADAPT TO AGE:** Your language style MUST be adapted for a ${state.age || 'young'} year-old child. ${getAgeGuidance(state.age)}
4.  **STAY ON TOPIC:** Keep the conversation related to your character's context.
5.  **KEEP IT SHORT:** Respond in 1-3 short sentences. NEVER switch to Portuguese.
6.  **TRANSLATION:** After your complete English response, ALWAYS add a separator on a new line: [TRANSLATION]. On the next line, provide a full, natural Portuguese translation of your English response.
End.`.trim();
}
async function handleSend(text){
  if(!text||!text.trim())return; addMsg({from:'kid',text:text,speak:false});
  const lower=text.toLowerCase(),cat=categories.find(c=>c.id===state.categoryId);
  if(cat&&cat.vocab.some(([en])=>lower.includes(en.toLowerCase()))){setStars(Math.min(5,state.stars+1));giveMedal('vocab-star');}
  if(/(please|thank you)/i.test(lower))giveMedal('polite-kid'); if(/\b(what|where|who|how|why|do you)\b/i.test(lower))giveMedal('curious-mind');
  if (/(happy|sad|love|like|fine|good|great)/i.test(lower)) giveMedal('feeling-fine');
  if(!state.achievements['first-talk'])giveMedal('first-talk');
  try{
    state.history.push({role:'user',content:text});
    const res=await fetch(`${BACKEND_URL}/api/chat`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:state.history.slice(-12),systemPrompt:buildSystemPrompt()})});
    if(!res.ok)throw new Error('Falha na comunica√ß√£o com o backend: '+res.status);
    const data=await res.json(),aiText=data.reply||'I am here to help! üòä';
    addMsg({from:'ai',text:aiText,translate:true}); state.history.push({role:'assistant',content:aiText});
  }catch(err){console.error(err);addMsg({from:'ai',text:'Tive um problema de comunica√ß√£o com o servidor. üõü',translate:false,speak:false});}
}

/* ---------- L√ìGICA DOS JOGOS ---------- */
function showGame(gameId) {
    document.querySelectorAll('.game-area').forEach(area => area.classList.add('hidden'));
    document.querySelectorAll('.game-button').forEach(btn => btn.classList.remove('active'));
    $(`#${gameId}Game`).classList.remove('hidden');
    $(`button[data-game="${gameId}"]`).classList.add('active');
    $('#gameWinMessage').classList.add('hidden');
    $('#gameFeedback').textContent = '';
    state.currentGame.id = gameId;

    const writingGames = ['missing', 'oddOneOut', 'scramble'];
    const hintBtn = $('#gameHintBtn');
    if(hintBtn){
        if (writingGames.includes(gameId)) {
            hintBtn.style.display = 'block';
        } else {
            hintBtn.style.display = 'none';
        }
    }

    switch (gameId) {
        case 'wordEmoji': startWordEmojiGame(); break;
        case 'memory': startMemoryGame(); break;
        case 'scramble': startScrambleGame(); break;
        case 'missing': startMissingGame(); break;
        case 'oddOneOut': startOddOneOutGame(); break;
    }
}
function setupGameNav() { document.querySelectorAll('.game-button').forEach(btn => btn.addEventListener('click', () => showGame(btn.dataset.game))); }
function startWordEmojiGame() {
    const wordsContainer = $('#gameWordsContainer'), emojisContainer = $('#gameEmojisContainer');
    wordsContainer.innerHTML = ''; emojisContainer.innerHTML = '';
    state.currentGame = { ...state.currentGame, selectedWord: null, selectedEmoji: null, pairsLeft: 0 };
    const categoryKeys = Object.keys(gameVocab), randomCategoryKey = categoryKeys[Math.floor(Math.random() * categoryKeys.length)];
    const gamePairs = [...gameVocab[randomCategoryKey]];
    state.currentGame.pairsLeft = gamePairs.length;
    const words = shuffle(gamePairs.map(p => p[0])), emojis = shuffle(gamePairs.map(p => p[1]));
    words.forEach(word => {
        const btn = document.createElement('button'); btn.className = 'game-option p-4 bg-white rounded-xl border-2 border-slate-200 font-bold capitalize transition-transform';
        btn.textContent = word; btn.dataset.word = word;
        btn.onclick = () => { if(btn.classList.contains('correct')) return; if (state.currentGame.selectedWord) document.querySelectorAll('[data-word]').forEach(b => b.classList.remove('selected')); state.currentGame.selectedWord = btn; btn.classList.add('selected'); checkWordEmojiMatch(); };
        wordsContainer.appendChild(btn);
    });
    emojis.forEach(emoji => {
        const btn = document.createElement('button'); btn.className = 'game-option p-4 bg-white rounded-xl border-2 border-slate-200 text-3xl transition-transform';
        btn.textContent = emoji; btn.dataset.emoji = emoji;
        btn.onclick = () => { if(btn.classList.contains('correct')) return; if (state.currentGame.selectedEmoji) document.querySelectorAll('[data-emoji]').forEach(b => b.classList.remove('selected')); state.currentGame.selectedEmoji = btn; btn.classList.add('selected'); checkWordEmojiMatch(); };
        emojisContainer.appendChild(btn);
    });
}
function checkWordEmojiMatch() {
    const { selectedWord, selectedEmoji } = state.currentGame;
    if (!selectedWord || !selectedEmoji) return;
    const word = selectedWord.dataset.word, emoji = selectedEmoji.dataset.emoji;
    const category = Object.values(gameVocab).flat(), correctPair = category.find(p => p[0] === word);
    const feedback = $('#gameFeedback');
    if (correctPair && correctPair[1] === emoji) {
        feedback.textContent = 'Correto! üéâ'; feedback.className = 'text-center text-sm h-5 mb-4 font-bold text-emerald-600';
        selectedWord.classList.add('correct'); selectedEmoji.classList.add('correct');
        playCorrect();
        state.currentGame.pairsLeft--;
        if (state.currentGame.pairsLeft === 0) $('#gameWinMessage').classList.remove('hidden');
    } else {
        feedback.textContent = 'Tente novamente! üòü'; feedback.className = 'text-center text-sm h-5 mb-4 font-bold text-red-600';
        selectedWord.classList.add('incorrect'); selectedEmoji.classList.add('incorrect');
        playWrong();
        setTimeout(() => { selectedWord.classList.remove('incorrect'); selectedEmoji.classList.remove('incorrect'); }, 800);
    }
    state.currentGame.selectedWord = null; state.currentGame.selectedEmoji = null;
    setTimeout(() => { document.querySelectorAll('.game-option').forEach(b => b.classList.remove('selected')); if (! (correctPair && correctPair[1] === emoji)) feedback.textContent = ''; }, 1000);
}
function startMemoryGame() {
    const board = $('#memoryGameBoard'); board.innerHTML = ''; state.currentGame.flippedCards = []; state.currentGame.lockBoard = false;
    const categoryKeys = Object.keys(gameVocab), randomCategoryKey = categoryKeys[Math.floor(Math.random() * categoryKeys.length)];
    const pairs = shuffle([...gameVocab[randomCategoryKey]]).slice(0, 8); // Pega 8 pares aleat√≥rios
    let cards = [];
    pairs.forEach(pair => {
        cards.push({ type: 'word', value: pair[0], pairId: pair[0] });
        cards.push({ type: 'emoji', value: pair[1], pairId: pair[0] });
    });
    shuffle(cards);
    cards.forEach(cardData => {
        const cardEl = document.createElement('div'); cardEl.className = 'memory-card w-24 h-24 relative'; cardEl.dataset.pairId = cardData.pairId;
        cardEl.innerHTML = `<div class="front w-full h-full bg-violet-500 rounded-lg"></div><div class="back w-full h-full bg-white rounded-lg text-2xl font-bold border-2 flex items-center justify-center p-1">${cardData.value}</div>`;
        cardEl.addEventListener('click', () => {
            if (state.currentGame.lockBoard || cardEl.classList.contains('flipped') || state.currentGame.flippedCards.length >= 2) return;
            cardEl.classList.add('flipped'); state.currentGame.flippedCards.push(cardEl);
            if (state.currentGame.flippedCards.length === 2) {
                state.currentGame.lockBoard = true;
                const [card1, card2] = state.currentGame.flippedCards;
                if (card1.dataset.pairId === card2.dataset.pairId) {
                    playCorrect(); state.currentGame.flippedCards = []; state.currentGame.lockBoard = false;
                    if (document.querySelectorAll('.memory-card:not(.flipped)').length === 0) $('#gameWinMessage').classList.remove('hidden');
                } else {
                    playWrong();
                    setTimeout(() => { card1.classList.remove('flipped'); card2.classList.remove('flipped'); state.currentGame.flippedCards = []; state.currentGame.lockBoard = false; }, 1200);
                }
            }
        });
        board.appendChild(cardEl);
    });
}
function createLetterKeyboard(word, answerContainer, lettersContainer, onCorrect) {
    const letters = shuffle([...new Set(word.split('')), ...'abcdefghijklmnopqrstuvwxyz'.split('').filter(l => !word.includes(l)).slice(0, 8)]);
    lettersContainer.innerHTML = '';
    answerContainer.textContent = '';
    letters.forEach(letter => {
        const btn = document.createElement('button');
        btn.className = 'game-option w-10 h-10 bg-white rounded-lg text-2xl font-bold border-2';
        btn.textContent = letter;
        btn.onclick = () => {
            if(answerContainer.textContent.length < 15) { // Limit length
              answerContainer.textContent += letter;
            }
        };
        lettersContainer.appendChild(btn);
    });
    const backspaceBtn = document.createElement('button');
    backspaceBtn.className = 'game-option w-10 h-10 bg-white rounded-lg text-2xl font-bold border-2';
    backspaceBtn.innerHTML = '‚å´';
    backspaceBtn.onclick = () => {
        answerContainer.textContent = answerContainer.textContent.slice(0, -1);
    };
    lettersContainer.appendChild(backspaceBtn);

    const checkBtn = document.createElement('button');
    checkBtn.className = 'w-full mt-4 px-6 py-2 bg-violet-500 text-white font-bold rounded-xl';
    checkBtn.textContent = 'Verificar';
    checkBtn.onclick = () => {
        if (answerContainer.textContent === word) {
            onCorrect();
        } else {
            playWrong(); $('#gameFeedback').textContent = 'Incorreto, tente de novo!';
            answerContainer.classList.add('incorrect');
            setTimeout(() => {
                answerContainer.classList.remove('incorrect');
            }, 800);
        }
    };
    if(lettersContainer.parentElement.querySelector('button.w-full') === null) {
        lettersContainer.parentElement.appendChild(checkBtn);
    }
}
function startScrambleGame() { 
    const emojiContainer = $('#scrambleEmoji'), answerContainer = $('#scrambleAnswer'), lettersContainer = $('#scrambleLetters'), feedback = $('#gameFeedback'), clearBtn = $('#scrambleClearBtn');
    emojiContainer.innerHTML = ''; answerContainer.innerHTML = ''; lettersContainer.innerHTML = ''; feedback.textContent = '';
    const categoryKeys = Object.keys(gameVocab), randomCategoryKey = categoryKeys[Math.floor(Math.random() * categoryKeys.length)];
    const [word, emoji] = shuffle(gameVocab[randomCategoryKey])[0];
    emojiContainer.textContent = emoji;
    const letters = shuffle(word.split(''));
     letters.forEach(letter => {
        const btn = document.createElement('button');
        btn.className = 'game-option w-10 h-10 bg-white rounded-lg text-2xl font-bold border-2';
        btn.textContent = letter;
        btn.onclick = () => {
            answerContainer.textContent += letter;
            btn.disabled = true;
            btn.classList.add('opacity-50');
            if(answerContainer.textContent.length === word.length) {
                if(answerContainer.textContent === word) {
                    playCorrect(); feedback.textContent = 'Correto!'; feedback.className = 'text-center text-sm h-5 mb-4 font-bold text-emerald-600';
                    $('#gameWinMessage').classList.remove('hidden');
                } else {
                    playWrong(); feedback.textContent = 'Incorreto, tente de novo!'; feedback.className = 'text-center text-sm h-5 mb-4 font-bold text-red-600';
                }
            }
        };
        lettersContainer.appendChild(btn);
    });
    clearBtn.onclick = () => {
        answerContainer.textContent = '';
        feedback.textContent = '';
        lettersContainer.querySelectorAll('button').forEach(btn => {
            btn.disabled = false;
            btn.classList.remove('opacity-50');
        });
    };
}
function startMissingGame() {
    const container = $('#missingEmojisContainer'), instruction = $('#missingGameInstruction'), feedback = $('#gameFeedback'), answerContainer = $('#missingAnswer'), lettersContainer = $('#missingLetters');
    container.innerHTML = ''; instruction.textContent = 'Memorize os emojis...'; feedback.textContent = ''; answerContainer.textContent = ''; lettersContainer.innerHTML = '';
    const hintContainer = $('#gameHintContainer'); hintContainer.innerHTML = '';
    if(lettersContainer.nextElementSibling?.tagName === 'BUTTON') lettersContainer.nextElementSibling.remove();
    const categoryKeys = Object.keys(gameVocab), randomCategoryKey = categoryKeys[Math.floor(Math.random() * categoryKeys.length)];
    const items = shuffle([...gameVocab[randomCategoryKey]]).slice(0, 4);
    const missingItem = items[0];
    items.forEach(item => container.innerHTML += `<div class="text-5xl">${item[1]}</div>`);
    
    const hintBtn = document.createElement('button');
    hintBtn.className = 'px-4 py-2 bg-amber-200 text-amber-900 font-bold rounded-xl text-sm';
    hintBtn.innerHTML = 'üí° Dica';
    hintBtn.onclick = () => { 
        feedback.textContent = `Dica: A palavra tem ${missingItem[0].length} letras.`; 
        hintBtn.remove(); 
    };
    hintContainer.appendChild(hintBtn);

    setTimeout(() => {
        container.innerHTML = '<div class="text-2xl font-bold">Qual desapareceu?</div>';
        setTimeout(() => {
            container.innerHTML = '';
            const displayItems = items.filter(item => item[0] !== missingItem[0]);
            displayItems.forEach(item => container.innerHTML += `<div class="text-5xl opacity-50">${item[1]}</div>`);
            instruction.textContent = 'Escreva o nome do emoji que est√° em falta!';
            createLetterKeyboard(missingItem[0], answerContainer, lettersContainer, () => {
                playCorrect(); feedback.textContent = 'Correto!'; feedback.className = 'text-center text-sm h-5 mb-4 font-bold text-emerald-600';
                $('#gameWinMessage').classList.remove('hidden');
                if(lettersContainer.nextElementSibling?.tagName === 'BUTTON') lettersContainer.nextElementSibling.remove();
            });
        }, 1500);
    }, 2500);
}
function startOddOneOutGame() {
    const container = $('#oddOneOutEmojis'), answerContainer = $('#oddOneOutAnswer'), lettersContainer = $('#oddOneOutLetters'), feedback = $('#gameFeedback');
    container.innerHTML = ''; answerContainer.textContent = ''; lettersContainer.innerHTML = ''; feedback.textContent = '';
    const hintContainer = $('#gameHintContainer'); hintContainer.innerHTML = '';
    if(lettersContainer.nextElementSibling?.tagName === 'BUTTON') lettersContainer.nextElementSibling.remove();
    const currentSet = shuffle([...oddOneOutSets])[0];
    shuffle(currentSet.emojis).forEach(emoji => container.innerHTML += `<div class="text-5xl">${emoji}</div>`);
    
    const hintBtn = document.createElement('button');
    hintBtn.className = 'px-4 py-2 bg-amber-200 text-amber-900 font-bold rounded-xl text-sm';
    hintBtn.innerHTML = 'üí° Dica';
    hintBtn.onclick = () => { 
        feedback.textContent = `Dica: A palavra tem ${currentSet.answer.length} letras.`; 
        hintBtn.remove(); 
    };
    hintContainer.appendChild(hintBtn);

    createLetterKeyboard(currentSet.answer, answerContainer, lettersContainer, () => {
        playCorrect(); feedback.textContent = 'Correto!'; feedback.className = 'text-center text-sm h-5 mb-4 font-bold text-emerald-600';
        $('#gameWinMessage').classList.remove('hidden');
        if(lettersContainer.nextElementSibling?.tagName === 'BUTTON') lettersContainer.nextElementSibling.remove();
    });
}


/* ---------- EVENTOS E INICIALIZA√á√ÉO ---------- */
function setupEventListeners(){
  setupGameNav();
  $('#viewToggleConversation').addEventListener('click', () => { $('#conversationView').style.display = 'block'; $('#gamesView').style.display = 'none';  $('#vocabularyView').style.display = 'none'; $('#viewToggleConversation').classList.add('bg-white', 'text-violet-600', 'shadow'); $('#viewToggleGames').classList.remove('bg-white', 'text-violet-600', 'shadow'); $('#viewToggleVocabulary').classList.remove('bg-white', 'text-violet-600', 'shadow'); });
  $('#viewToggleVocabulary').addEventListener('click', () => { $('#conversationView').style.display = 'none'; $('#gamesView').style.display = 'none'; $('#vocabularyView').style.display = 'block'; $('#viewToggleVocabulary').classList.add('bg-white', 'text-violet-600', 'shadow'); $('#viewToggleConversation').classList.remove('bg-white', 'text-violet-600', 'shadow'); $('#viewToggleGames').classList.remove('bg-white', 'text-violet-600', 'shadow'); });
  $('#viewToggleGames').addEventListener('click', () => { $('#conversationView').style.display = 'none'; $('#gamesView').style.display = 'block'; $('#vocabularyView').style.display = 'none'; $('#viewToggleGames').classList.add('bg-white', 'text-violet-600', 'shadow'); $('#viewToggleConversation').classList.remove('bg-white', 'text-violet-600', 'shadow'); $('#viewToggleVocabulary').classList.remove('bg-white', 'text-violet-600', 'shadow'); showGame('wordEmoji'); });
  $('#playAgainBtn').addEventListener('click', () => showGame(state.currentGame.id));
  $('#btnHint').addEventListener('click',()=>{const c=categories.find(x=>x.id===state.categoryId);let hint=c&&c.missions.length?c.missions[Math.floor(Math.random()*c.missions.length)]:'Try a short sentence in English. üòÄ';addMsg({from:'ai',text:hint.replace('__',state.userName||'...'),translate:true});});
  $('#btnClear').addEventListener('click',()=>{chatEl.innerHTML='';state.history=[];addMsg({from:'ai',text:'New beginning! Choose a scene to continue. ‚ú®',translate:true,speak:true});});
  $('#btnReset').addEventListener('click',()=>{ $('#confirmModal').classList.remove('hidden'); $('#confirmModal').classList.add('flex'); });
  $('#cancelReset').addEventListener('click',()=>{ $('#confirmModal').classList.add('hidden'); $('#confirmModal').classList.remove('flex'); });
  $('#confirmReset').addEventListener('click',()=>{localStorage.clear();window.location.reload();});
  $('#chatForm').addEventListener('submit',e=>{e.preventDefault();const text=msgInput.value.trim();if(text){msgInput.value='';msgInput.style.height='auto';handleSend(text);}});
  msgInput.addEventListener('input',()=>{msgInput.style.height='auto';msgInput.style.height=Math.min(120,msgInput.scrollHeight)+'px';});
  msgInput.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();$('#chatForm').dispatchEvent(new Event('submit'));}});
  $('#translateToggle').addEventListener('change',e=>{state.showTranslation=!!e.target.checked;});
  $('#voiceSelect').addEventListener('change',()=>{const v=$('#voiceSelect').value;$('#currentVoice').textContent=v?`Voz: ${v}`:`Voz: ${state.voice||'‚Äî'}`;});
  $('#testVoiceBtn').addEventListener('click',()=>{ttsSpeak(state.userName?`Hello ${state.userName}, nice to meet you!`:'Hello! Let us practice!',null);});
  $('#editProfile').addEventListener('click',()=>{ $('#startName').value=state.userName||''; $('#startAge').value=state.age||''; $('#startScreen').style.display='flex'; $('#app').classList.add('hidden');});
  $('#btnStart').addEventListener('click',()=>{
    const name=$('#startName').value.trim(),age=$('#startAge').value.trim();
    if(!name||!age){const msg=document.createElement('div');msg.textContent='Por favor, preencha nome e idade.';msg.className='text-red-600 font-bold mt-2 text-sm';const oldMsg=$('#startScreen').querySelector('.text-red-600');if(oldMsg)oldMsg.remove();$('#btnStart').parentElement.insertBefore(msg,$('#btnStart'));return;}
    state.userName=name;state.age=age;localStorage.setItem('ae_name',name);localStorage.setItem('ae_age',age);
    $('#profileDisplayName').textContent = `${name} (${age} anos)`;
    $('#startScreen').style.display='none';$('#app').classList.remove('hidden');chatEl.innerHTML='';
    addMsg({from:'ai',text:`Hello ${name}! Welcome to Adventure English üéâ [TRANSLATION] Ol√° ${name}! Bem-vindo(a) ao Adventure English üéâ`,translate:true,speak:true});
  });

  // --- C√ìDIGO DO MICROFONE MELHORADO ---
  const micStatus = $('#micStatus');
  const btnMic = $('#btnMic');

  // Verifica se a conex√£o √© segura (HTTPS), essencial para o microfone.
  if (window.isSecureContext === false) {
      micStatus.textContent = 'Use https:// para o microfone.';
      micStatus.classList.add('text-red-600');
      btnMic.disabled = true;
      btnMic.classList.add('opacity-50', 'cursor-not-allowed');
      return;
  }

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

  // Verifica se o navegador suporta a API de Reconhecimento de Voz.
  if (!SpeechRecognition) {
      micStatus.textContent = 'Navegador n√£o suporta voz.';
      micStatus.classList.add('text-red-600');
      btnMic.disabled = true;
      btnMic.classList.add('opacity-50', 'cursor-not-allowed');
      return; 
  }

  const recognition = new SpeechRecognition();
  let recognizing = false;
  recognition.lang = 'en-US';
  recognition.continuous = false;
  recognition.interimResults = false;
  micStatus.textContent = 'Pronto para ouvir';

  recognition.onstart = () => {
      recognizing = true;
      micStatus.textContent = 'Estou ouvindo...';
      micStatus.classList.remove('text-red-600');
      btnMic.textContent = '‚èπÔ∏è Parar';
  };

  recognition.onend = () => {
      recognizing = false;
      micStatus.textContent = 'Pronto para ouvir';
      btnMic.textContent = 'üé§ Falar';
  };

  recognition.onerror = (event) => {
      console.error('Erro no reconhecimento de voz:', event.error);
      if (event.error === 'not-allowed') {
          micStatus.textContent = 'Permiss√£o negada.';
      } else if (event.error === 'no-speech') {
          micStatus.textContent = 'N√£o ouvi nada.';
      } else {
          micStatus.textContent = 'Erro no microfone.';
      }
      micStatus.classList.add('text-red-600');
  };

  recognition.onresult = (event) => {
      const text = event.results[0][0].transcript;
      msgInput.value = text;
      // Opcional: envia a mensagem automaticamente ap√≥s reconhecer a fala.
      // $('#chatForm').dispatchEvent(new Event('submit')); 
  };

  btnMic.addEventListener('click', () => {
      if (recognizing) {
          recognition.stop();
      } else {
          try {
              micStatus.textContent = 'Pe√ßa permiss√£o...';
              micStatus.classList.remove('text-red-600');
              recognition.start();
          } catch (e) {
              console.error("Erro ao iniciar reconhecimento:", e);
              micStatus.textContent = 'Erro ao iniciar.';
              micStatus.classList.add('text-red-600');
          }
      }
  });
}

function init(){
  const savedName=localStorage.getItem('ae_name'),savedAge=localStorage.getItem('ae_age');
  if(savedName&&savedAge){
    state.userName=savedName;state.age=savedAge;
    $('#profileDisplayName').textContent = `${savedName} (${savedAge} anos)`;
    $('#startScreen').style.display='none';$('#app').classList.remove('hidden');
    addMsg({from:'ai',text:`Welcome back, ${savedName}! Let's continue! üòä [TRANSLATION] Bem-vindo(a) de volta, ${savedName}! Vamos continuar! üòä`,translate:true,speak:true});
  }else{
    $('#startScreen').style.display='flex';$('#app').classList.add('hidden');
  }
  renderScenes();renderCategories();renderVocab();renderMissions();setStars(0);renderBadges();
  $('#activeSceneName').textContent='Escolha uma cena';$('#currentVoice').textContent='Nenhuma';
  setupEventListeners();
}
init();
</script>
</body>
</html>

